<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Extintores - Ind.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove, push, onValue, off } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASb2kM0JyEAY-wClL3KFJFT6qprWmQkTA",
            authDomain: "extintor-e5cac.firebaseapp.com",
            databaseURL: "https://extintor-e5cac-default-rtdb.firebaseio.com/",
            projectId: "extintor-e5cac",
            storageBucket: "extintor-e5cac.firebasestorage.app",
            messagingSenderId: "752054608963",
            appId: "1:752054608963:web:91368916dc2efb92f660f6",
            measurementId: "G-8447J9SWZN"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);

            // Disponibilizar globalmente
            window.database = database;
            window.ref = ref;
            window.set = set;
            window.get = get;
            window.update = update;
            window.remove = remove;
            window.push = push;
            window.onValue = onValue;
            window.off = off;
            window.firebaseReady = true;

            console.log('Firebase inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
            window.firebaseError = error;
        }
    </script>
    <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #1a1a1a 0%, #2e2e2e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100%;
            overflow-x: hidden;
        }

        /* Corre√ß√£o para Kodular - Previne bugs de input */
        .modal-content {
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .input-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .cards-container::-webkit-scrollbar {
            width: 10px;
        }

        .cards-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        .cards-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #232125, #eb4d25);
            border-radius: 10px;
        }



        .input-field {
            background: rgba(46, 46, 46, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .input-field:focus {
            border-color: #ff3c3c;
            background: rgba(46, 46, 46, 1);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 60, 60, 0.1);
        }

        /* Previne zoom no iOS */
        .input-field,
        select,
        textarea {
            font-size: 16px !important;
        }

        .card-gradient {
            background: linear-gradient(145deg, #2e2e2e, #1a1a1a);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-vencido {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .status-proximo {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .status-ok {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        /* Bot√µes com cores harmoniosas - Paleta moderna */
        .btn-primary {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
            color: white;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.4);
            background: linear-gradient(135deg, #ff3742, #e73c3c);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #5352ed, #3742fa);
            box-shadow: 0 4px 15px rgba(83, 82, 237, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(83, 82, 237, 0.4);
            background: linear-gradient(135deg, #3742fa, #2f3cfa);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ed573, #1dd1a1);
            box-shadow: 0 4px 15px rgba(46, 213, 115, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46, 213, 115, 0.4);
            background: linear-gradient(135deg, #1dd1a1, #00d2d3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa502, #ff6348);
            box-shadow: 0 4px 15px rgba(255, 165, 2, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 165, 2, 0.4);
            background: linear-gradient(135deg, #ff6348, #ff4757);
        }

        .btn-info {
            background: linear-gradient(135deg, #70a1ff, #5352ed);
            box-shadow: 0 4px 15px rgba(112, 161, 255, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(112, 161, 255, 0.4);
            background: linear-gradient(135deg, #5352ed, #3742fa);
        }

        .btn-purple {
            background: linear-gradient(135deg, #a55eea, #8854d0);
            box-shadow: 0 4px 15px rgba(165, 94, 234, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(165, 94, 234, 0.4);
            background: linear-gradient(135deg, #8854d0, #7c4dff);
        }

        /* Bot√£o de manuten√ß√£o especial */
        .btn-maintenance {
            background: linear-gradient(135deg, #70a1ff, #5352ed);
            box-shadow: 0 4px 15px rgba(112, 161, 255, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-maintenance:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(112, 161, 255, 0.4);
            background: linear-gradient(135deg, #5352ed, #3742fa);
        }

        .btn-maintenance-active {
            background: linear-gradient(135deg, #ffa502, #ff6348);
            box-shadow: 0 4px 15px rgba(255, 165, 2, 0.3);
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-maintenance-active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 165, 2, 0.4);
            background: linear-gradient(135deg, #ff6348, #ff4757);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Cards melhorados */
        .extintor-card {
            background: linear-gradient(145deg, #2e2e2e, #1a1a1a);
            border-radius: 20px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .extintor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ff4757, #ff3742, #ff6b7a, #ff4757);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                background-position: 200% 0;
            }

            50% {
                background-position: -200% 0;
            }
        }

        .extintor-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            border-color: rgba(255, 71, 87, 0.3);
        }

        .extintor-card:hover::before {
            animation-duration: 1.5s;
        }

        /* Separador decorativo entre cards */
        .extintor-card:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #ff4757, #ff3742, #ff4757, transparent);
            border-radius: 2px;
            opacity: 0.6;
            z-index: 10;
        }

        /* Efeito de brilho sutil no separador */
        .extintor-card:not(:last-child)::before {
            content: '';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 71, 87, 0.3), rgba(255, 55, 66, 0.5), rgba(255, 71, 87, 0.3), transparent);
            border-radius: 1px;
            z-index: 9;
        }

        /* Container dos cards com espa√ßamento melhorado */
        .cards-container {
            position: relative;
        }

        .cards-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(255, 71, 87, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(83, 82, 237, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(46, 213, 115, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .extintor-card {
            position: relative;
            z-index: 1;
        }

        /* QR Code no card */
        .qr-code-container {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 6px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            z-index: 20;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .qr-code-container canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 6px;
        }

        /* Melhorias de espa√ßamento */
        .card-header {
            padding: 16px 16px 12px 16px;
        }

        .card-content {
            padding: 0 16px 16px 16px;
        }

        .info-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 16px;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-box-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .info-box-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .info-box-value {
            font-size: 15px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .status-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-icon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .action-buttons {
            display: grid;
            gap: 8px;
            margin-top: 16px;
        }

        .maintenance-button {
            margin-bottom: 8px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Relat√≥rio melhorado */
        .report-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .report-header {
            background: linear-gradient(135deg, #1a1a1a, #2e2e2e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .report-section {
            padding: 25px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .report-table th,
        .report-table td {
            padding: 16px 12px;
            border: 1px solid #ddd;
            font-size: 14px;
            text-align: left;
            vertical-align: top;
        }

        .report-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .report-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .timeline-item {
            border-left: 3px solid #ff3c3c;
            padding-left: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 8px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background: #ff3c3c;
        }

        .timeline-item.success {
            border-left-color: #2ed573;
        }

        .timeline-item.success::before {
            background: #2ed573;
        }

        .timeline-item.warning {
            border-left-color: #ffa502;
        }

        .timeline-item.warning::before {
            background: #ffa502;
        }

        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .card-header {
                padding: 14px 14px 10px 14px;
            }

            .card-content {
                padding: 0 14px 14px 14px;
            }

            .qr-code-container {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
                padding: 5px;
                border-radius: 8px;
            }

            .info-grid {
                gap: 10px;
                margin-bottom: 14px;
            }

            .info-box {
                padding: 10px;
            }

            .action-buttons {
                gap: 8px;
                margin-top: 14px;
            }

            .button-grid {
                gap: 8px;
            }

            .modal-content {
                margin: 12px;
                max-height: 90vh;
                padding: 20px;
            }

            .report-section {
                padding: 16px;
            }

            .report-table th,
            .report-table td {
                padding: 10px 6px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .card-header {
                padding: 12px 12px 8px 12px;
            }

            .card-content {
                padding: 0 12px 12px 12px;
            }

            .qr-code-container {
                width: 40px;
                height: 40px;
                top: 8px;
                right: 8px;
                padding: 4px;
                border-radius: 6px;
            }

            .info-grid {
                gap: 8px;
                margin-bottom: 12px;
            }

            .info-box {
                padding: 8px;
            }

            .info-box-title {
                font-size: 12px;
            }

            .info-box-value {
                font-size: 13px;
            }

            .action-buttons {
                gap: 6px;
                margin-top: 12px;
            }

            .button-grid {
                gap: 6px;
            }

            .modal-content {
                margin: 8px;
                padding: 16px;
            }
        }

        /* Melhorias para impress√£o/PDF */
        @media print {
            .report-card {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 20px;
            }

            .report-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .report-table {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        /* Sistema de Notifica√ß√µes */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .notification {
            background: linear-gradient(145deg, #2e2e2e, #1a1a1a);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border-left: 4px solid;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left-color: #2ed573;
        }

        .notification.warning {
            border-left-color: #ffa502;
        }

        .notification.error {
            border-left-color: #ff4757;
        }

        .notification.info {
            border-left-color: #70a1ff;
        }

        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: bold;
            font-size: 14px;
            color: white;
        }

        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .notification-message {
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 12px 12px;
            animation: notificationProgress 5s linear forwards;
        }

        @keyframes notificationProgress {
            from {
                width: 100%;
            }

            to {
                width: 0%;
            }
        }

        /* Alertas de Manuten√ß√£o */
        .alert-banner {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            animation: alertPulse 2s infinite;
        }

        .alert-banner.warning {
            background: linear-gradient(135deg, #ffa502, #ff6348);
        }

        @keyframes alertPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .alert-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: alertShine 3s infinite;
        }

        @keyframes alertShine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }
    </style>
</head>

<body class="min-h-full text-white">
    <!-- Container de Notifica√ß√µes -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Banner de Alertas -->
    <div id="alertBanner" class="alert-banner hidden">
        <div id="alertMessage"></div>
    </div>
    <!-- Header -->
    <header class="card-gradient p-6 sm:p-8 mb-8 sm:mb-10">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-6 sm:space-y-0">
                <div class="flex items-center space-x-4 sm:space-x-6">
                    <i class="fas fa-fire-extinguisher text-3xl sm:text-4xl text-red-500"></i>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-1">Controle de Extintores</h1>
                        <p class="text-sm sm:text-base text-gray-300">Sistema Industrial</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5">
                    <button onclick="openModal()"
                        class="btn-primary px-4 sm:px-5 py-3 sm:py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 text-sm sm:text-base transition-all">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline">Novo Extintor</span>
                        <span class="sm:hidden">Novo</span>
                    </button>
                    <button onclick="openScannerModal()"
                        class="btn-secondary px-4 sm:px-5 py-3 sm:py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all text-sm sm:text-base">
                        <i class="fas fa-qrcode"></i>
                        <span class="hidden sm:inline">Scanner QR</span>
                        <span class="sm:hidden">Scanner</span>
                    </button>
                    <button onclick="generateAllQRCodes()"
                        class="btn-purple px-4 sm:px-5 py-3 sm:py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all text-sm sm:text-base">
                        <i class="fas fa-download"></i>
                        <span class="hidden sm:inline">QR Codes</span>
                        <span class="sm:hidden">QRs</span>
                    </button>
                    <button onclick="generateReport()"
                        class="btn-warning px-4 sm:px-5 py-3 sm:py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all text-sm sm:text-base">
                        <i class="fas fa-file-pdf"></i>
                        <span class="hidden sm:inline">Relat√≥rio PDF</span>
                        <span class="sm:hidden">PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard Cards -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 mb-8 sm:mb-10">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
            <div class="card-gradient p-5 sm:p-7 rounded-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-gray-300 text-sm sm:text-base mb-2">Total</p>
                        <p id="totalExtintores" class="text-2xl sm:text-3xl font-bold text-white">0</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-blue-500 bg-opacity-20 rounded-full">
                        <i class="fas fa-fire-extinguisher text-lg sm:text-xl text-blue-400"></i>
                    </div>
                </div>
            </div>

            <div class="card-gradient p-5 sm:p-7 rounded-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-gray-300 text-sm sm:text-base mb-2">Vencidos</p>
                        <p id="totalVencidos" class="text-2xl sm:text-3xl font-bold text-red-400">0</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-red-500 bg-opacity-20 rounded-full">
                        <i class="fas fa-exclamation-triangle text-lg sm:text-xl text-red-400 pulse-animation"></i>
                    </div>
                </div>
            </div>

            <div class="card-gradient p-5 sm:p-7 rounded-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-gray-300 text-sm sm:text-base mb-2">Pr√≥ximos</p>
                        <p id="totalProximos" class="text-2xl sm:text-3xl font-bold text-yellow-400">0</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-yellow-500 bg-opacity-20 rounded-full">
                        <i class="fas fa-clock text-lg sm:text-xl text-yellow-400"></i>
                    </div>
                </div>
            </div>

            <div class="card-gradient p-5 sm:p-7 rounded-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-gray-300 text-sm sm:text-base mb-2">Em Dia</p>
                        <p id="totalEmDia" class="text-2xl sm:text-3xl font-bold text-green-400">0</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 bg-green-500 bg-opacity-20 rounded-full">
                        <i class="fas fa-check-circle text-lg sm:text-xl text-green-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros e Busca -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 mb-8 sm:mb-10">
        <div class="card-gradient p-6 sm:p-8 rounded-xl">
            <div class="space-y-6">
                <!-- Linha 1: Busca -->
                <div class="w-full">
                    <input type="text" id="searchInput" placeholder="Buscar extintor..."
                        class="input-field w-full px-4 sm:px-5 py-3 sm:py-4 rounded-xl text-white placeholder-gray-400 text-sm sm:text-base">
                </div>

                <!-- Linha 2: Filtros -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5">
                    <select id="filterTipo"
                        class="input-field px-4 sm:px-5 py-3 sm:py-4 rounded-xl text-white text-sm sm:text-base">
                        <option value="">Todos os Tipos</option>
                        <option value="P√≥ Qu√≠mico">P√≥ Qu√≠mico</option>
                        <option value="CO2">CO2</option>
                        <option value="√Ågua">√Ågua</option>
                        <option value="BC">BC</option>
                    </select>

                    <select id="filterStatus"
                        class="input-field px-4 sm:px-5 py-3 sm:py-4 rounded-xl text-white text-sm sm:text-base">
                        <option value="">Todos os Status</option>
                        <option value="vencido">Vencidos</option>
                        <option value="proximo">Pr√≥ximos (30 dias)</option>
                        <option value="ok">Em Dia</option>
                    </select>

                    <button onclick="clearFilters()"
                        class="bg-gray-600 hover:bg-gray-700 px-4 sm:px-5 py-3 sm:py-4 rounded-xl font-semibold transition-all text-sm sm:text-base flex items-center justify-center space-x-2">
                        <i class="fas fa-times"></i>
                        <span>Limpar Filtros</span>
                    </button>
                </div>

                <!-- Linha 3: Controles -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <!-- Visualiza√ß√£o -->
                    <button id="viewCards" onclick="setView('cards')"
                        class="btn-primary px-3 sm:px-4 py-3 sm:py-4 rounded-xl font-semibold text-sm sm:text-base flex items-center justify-center space-x-2">
                        <i class="fas fa-th-large"></i>
                        <span class="hidden sm:inline">Cards</span>
                    </button>
                    <button id="viewList" onclick="setView('list')"
                        class="bg-gray-600 hover:bg-gray-700 px-3 sm:px-4 py-3 sm:py-4 rounded-xl font-semibold transition-all text-sm sm:text-base flex items-center justify-center space-x-2">
                        <i class="fas fa-list"></i>
                        <span class="hidden sm:inline">Lista</span>
                    </button>

                    <!-- A√ß√µes R√°pidas -->
                    <button onclick="updateAllToMaintenance()"
                        class="bg-orange-600 hover:bg-orange-700 px-3 sm:px-4 py-3 sm:py-4 rounded-xl font-semibold transition-all text-sm sm:text-base flex items-center justify-center space-x-2">
                        <i class="fas fa-wrench"></i>
                        <span class="hidden sm:inline">Manuten√ß√£o</span>
                    </button>
                    <button onclick="updateAllToOk()"
                        class="bg-green-600 hover:bg-green-700 px-3 sm:px-4 py-3 sm:py-4 rounded-xl font-semibold transition-all text-sm sm:text-base flex items-center justify-center space-x-2">
                        <i class="fas fa-check"></i>
                        <span class="hidden sm:inline">Todos OK</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Extintores -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 mb-6 sm:mb-8">
        <div id="extintoresList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8">
            <!-- Extintores ser√£o inseridos aqui -->
        </div>
    </div>

    <!-- Modal de Cadastro/Edi√ß√£o -->
    <div id="modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4 sm:p-6">
        <div class="modal-content card-gradient p-6 sm:p-10 rounded-2xl max-w-5xl w-full">
            <div class="flex justify-between items-center mb-8">
                <h2 id="modalTitle" class="text-2xl sm:text-3xl font-bold text-white">Novo Extintor</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl transition-colors p-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Formul√°rio -->
                <div>
                    <form id="extintorForm" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">N√∫mero *</label>
                                <input type="text" id="numero" required
                                    class="input-field px-5 py-4 rounded-xl text-white">
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Localiza√ß√£o *</label>
                                <input type="text" id="localizacao" required
                                    class="input-field px-5 py-4 rounded-xl text-white">
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Carga *</label>
                                <input type="text" id="carga" required
                                    class="input-field px-5 py-4 rounded-xl text-white">
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Tipo *</label>
                                <select id="tipo" required class="input-field px-5 py-4 rounded-xl text-white">
                                    <option value="">Selecione o tipo</option>
                                    <option value="P√≥ Qu√≠mico">P√≥ Qu√≠mico</option>
                                    <option value="CO2">CO2</option>
                                    <option value="√Ågua">√Ågua</option>
                                    <option value="BC">BC</option>
                                </select>
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Peso (Kg) *</label>
                                <input type="number" id="kg" required
                                    class="input-field px-5 py-4 rounded-xl text-white">
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Lacrado</label>
                                <select id="lacrado" class="input-field px-5 py-4 rounded-xl text-white">
                                    <option value="Sim">Sim</option>
                                    <option value="N√£o">N√£o</option>
                                </select>
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Status</label>
                                <select id="emManutencao" class="input-field px-5 py-4 rounded-xl text-white">
                                    <option value="false">Normal</option>
                                    <option value="true">Em Manuten√ß√£o</option>
                                </select>
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">√öltima Manuten√ß√£o *</label>
                                <input type="date" id="ultimaManutencao" required
                                    class="input-field px-5 py-4 rounded-xl text-white">
                            </div>

                            <div class="input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Pr√≥xima Manuten√ß√£o</label>
                                <input type="date" id="proximaManutencao" readonly
                                    class="input-field px-5 py-4 rounded-xl text-white bg-gray-700 cursor-not-allowed">
                                <p class="text-xs text-gray-400 mt-2">Calculada automaticamente (+1 ano)</p>
                            </div>

                            <div class="sm:col-span-2 input-container">
                                <label class="block text-gray-300 mb-3 text-sm font-medium">Respons√°vel pela
                                    Manuten√ß√£o</label>
                                <input type="text" id="responsavel" class="input-field px-5 py-4 rounded-xl text-white"
                                    placeholder="Nome do t√©cnico/empresa">
                            </div>
                        </div>

                        <div class="input-container">
                            <label class="block text-gray-300 mb-3 text-sm font-medium">Observa√ß√£o</label>
                            <textarea id="observacao" rows="4"
                                class="input-field px-5 py-4 rounded-xl text-white resize-none"></textarea>
                        </div>

                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-5 pt-6">
                            <button type="submit"
                                class="btn-success flex-1 py-4 px-6 rounded-xl font-semibold transition-all text-base">
                                <i class="fas fa-save mr-3"></i>Salvar Extintor
                            </button>
                            <button type="button" onclick="closeModal()"
                                class="bg-gray-600 hover:bg-gray-700 flex-1 py-4 px-6 rounded-xl font-semibold transition-all text-base">
                                <i class="fas fa-times mr-3"></i>Cancelar
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Hist√≥rico -->
                <div id="historicoSection" class="hidden lg:block">
                    <div class="card-gradient p-8 rounded-2xl h-full">
                        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-history mr-3 text-blue-400"></i>
                            Hist√≥rico do Extintor
                        </h3>
                        <div id="historicoContent" class="space-y-5 max-h-96 overflow-y-auto">
                            <p class="text-gray-400 text-sm">Selecione um extintor para ver o hist√≥rico</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Hist√≥rico (Mobile) -->
    <div id="historicoModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-history mr-2 text-blue-400"></i>
                    Hist√≥rico Completo
                </h2>
                <button onclick="closeHistoricoModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="historicoModalContent" class="space-y-4">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal do Scanner QR -->
    <div id="scannerModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-qrcode mr-2 text-blue-400"></i>
                    Scanner QR Code
                </h2>
                <button onclick="closeScannerModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="qr-reader" class="mb-4 rounded-lg overflow-hidden"></div>

            <div id="scanResult" class="hidden">
                <div class="bg-green-900 bg-opacity-30 border border-green-500 p-4 rounded-lg mb-4">
                    <h3 class="text-green-400 font-bold mb-2">‚úÖ QR Code Detectado!</h3>
                    <div id="scanResultContent" class="text-white text-sm space-y-2">
                        <!-- Resultado ser√° preenchido aqui -->
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="editScannedExtintor()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg font-semibold transition-all">
                        <i class="fas fa-edit mr-2"></i>Editar
                    </button>
                    <button onclick="resetScanner()"
                        class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg font-semibold transition-all">
                        <i class="fas fa-redo mr-2"></i>Novo Scan
                    </button>
                </div>
            </div>

            <div class="text-center">
                <button onclick="closeScannerModal()"
                    class="bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded-lg font-semibold transition-all">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Informa√ß√µes do Extintor (Scanner) -->
    <div id="extintorInfoModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 rounded-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-fire-extinguisher mr-2 text-red-400"></i>
                    Informa√ß√µes do Extintor
                </h2>
                <button onclick="closeExtintorInfoModal()" class="text-gray-400 hover:text-white text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="extintorInfoContent">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="flex space-x-3 mt-6">
                <button id="editExtintorFromModal"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 px-4 rounded-lg font-semibold transition-all">
                    <i class="fas fa-edit mr-2"></i>Editar
                </button>
                <button onclick="closeExtintorInfoModal()"
                    class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 px-4 rounded-lg font-semibold transition-all">
                    <i class="fas fa-times mr-2"></i>Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="card-gradient p-6 sm:p-8 rounded-xl max-w-md w-full">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl sm:text-6xl text-red-400 mb-3 sm:mb-4"></i>
                <h3 class="text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4">Confirmar Exclus√£o</h3>
                <p class="text-sm sm:text-base text-gray-300 mb-4 sm:mb-6">Tem certeza que deseja excluir este extintor?
                    Esta a√ß√£o n√£o pode ser desfeita.</p>

                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="confirmDelete"
                        class="bg-red-600 hover:bg-red-700 flex-1 py-2 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base">
                        Excluir
                    </button>
                    <button onclick="closeDeleteModal()"
                        class="bg-gray-600 hover:bg-gray-700 flex-1 py-2 sm:py-3 rounded-lg font-semibold transition-all text-sm sm:text-base">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea do Relat√≥rio (oculta) -->
    <div id="reportContent"
        style="display: none; background: white; color: black; font-family: Arial, sans-serif; line-height: 1.4;">
        <div class="report-header"
            style="background: linear-gradient(135deg, #1a1a1a, #2e2e2e); color: white; padding: 30px; text-align: center; margin-bottom: 0;">
            <h1 style="margin: 0; font-size: 36px; font-weight: bold;">
                <i class="fas fa-fire-extinguisher" style="margin-right: 15px; color: #ff4757;"></i>
                Relat√≥rio de Extintores - Sistema Industrial
            </h1>
            <p style="margin: 20px 0 0 0; font-size: 18px; opacity: 0.9;">
                Gerado em: <span id="reportDate"></span>
            </p>
        </div>

        <div class="report-section" style="padding: 25px;">
            <!-- Cards dos Extintores -->
            <div class="report-card">
                <div
                    style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; margin: 0; border-radius: 16px 16px 0 0;">
                    <h2 style="margin: 0; font-size: 28px; font-weight: bold;">üî• Relat√≥rio de Extintores</h2>
                    <p style="margin: 15px 0 0 0; font-size: 18px; opacity: 0.9;">
                        Total: <span id="reportTotal" style="font-weight: bold; font-size: 20px;">0</span> |
                        Vencidos: <span id="reportVencidos"
                            style="color: #e74c3c; font-weight: bold; font-size: 20px;">0</span> |
                        Pr√≥ximos: <span id="reportProximos"
                            style="color: #f39c12; font-weight: bold; font-size: 20px;">0</span> |
                        Em Dia: <span id="reportEmDia"
                            style="color: #27ae60; font-weight: bold; font-size: 20px;">0</span>
                    </p>
                </div>
                <div class="report-section" id="reportCardsList"
                    style="padding: 25px; background: white; border-radius: 0 0 16px 16px;">
                    <!-- Cards ser√£o preenchidos dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let extintores = [];
        let editingId = null;
        let currentView = 'cards';
        let historico = {};
        let html5QrcodeScanner = null;
        let scannedExtintorId = null;
        let firebaseReady = false;

        // Aguardar Firebase estar pronto
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 segundos

                const checkFirebase = () => {
                    attempts++;

                    if (window.firebaseError) {
                        reject(window.firebaseError);
                        return;
                    }

                    if (window.firebaseReady && window.database && window.ref && window.set) {
                        firebaseReady = true;
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Timeout ao aguardar Firebase'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log('Aguardando Firebase...');
                await waitForFirebase();
                console.log('Firebase pronto, inicializando dados...');

                await initializeFirebaseData();
                await loadExtintoresFromFirebase();
                updateDashboard();
                setupEventListeners();
                checkUrlParameters();

                // Verificar alertas ap√≥s carregar
                setTimeout(() => {
                    checkProximasManutencoes();
                }, 1000);

                console.log('Sistema inicializado com sucesso!');
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);

                // Fallback para dados locais se Firebase falhar
                console.log('Tentando carregar dados locais...');
                loadFromLocalStorage();
                updateDashboard();
                setupEventListeners();
                checkUrlParameters();

                showNotification('‚ö†Ô∏è Modo Offline', 'Conectado com dados locais. Algumas funcionalidades podem estar limitadas.', 'warning');
            }
        });

        // Verificar se h√° par√¢metros na URL (QR Code escaneado)
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const extintorId = urlParams.get('extintor');

            if (extintorId) {
                // Limpar URL sem recarregar a p√°gina
                window.history.replaceState({}, document.title, window.location.pathname);

                // Buscar extintor e abrir modal
                const extintor = extintores.find(e => e.id === extintorId);
                if (extintor) {
                    // Pequeno delay para garantir que a p√°gina carregou
                    setTimeout(() => {
                        showExtintorModal(extintor);
                    }, 500);
                } else {
                    // Extintor n√£o encontrado
                    setTimeout(() => {
                        alert(`Extintor n√£o encontrado! ID: ${extintorId}`);
                    }, 500);
                }
            }
        }

        // Sistema de fallback para localStorage
        function loadFromLocalStorage() {
            try {
                const savedExtintores = localStorage.getItem('extintores');
                const savedHistorico = localStorage.getItem('historico');

                if (savedExtintores) {
                    extintores = JSON.parse(savedExtintores);
                } else {
                    // Dados padr√£o se n√£o houver nada salvo
                    initializeDefaultData();
                }

                if (savedHistorico) {
                    historico = JSON.parse(savedHistorico);
                } else {
                    historico = {};
                }

                console.log(`Carregados ${extintores.length} extintores do localStorage`);
            } catch (error) {
                console.error('Erro ao carregar dados locais:', error);
                initializeDefaultData();
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('extintores', JSON.stringify(extintores));
                localStorage.setItem('historico', JSON.stringify(historico));
            } catch (error) {
                console.error('Erro ao salvar dados locais:', error);
            }
        }

        // Fun√ß√µes Firebase Realtime Database
        async function initializeFirebaseData() {
            try {
                const extintoresRef = window.ref(window.database, 'extintores');
                const snapshot = await window.get(extintoresRef);

                if (!snapshot.exists()) {
                    // Adicionar dados padr√£o se n√£o existirem
                    await addDefaultData();
                }
            } catch (error) {
                console.error('Erro ao verificar dados:', error);
                throw error;
            }
        }

        async function loadExtintoresFromFirebase() {
            try {
                const db = window.database;

                // üî• Executa ambas as leituras ao mesmo tempo
                const [extintoresSnap, historicoSnap] = await Promise.all([
                    window.get(window.ref(db, 'extintores')),
                    window.get(window.ref(db, 'historico'))
                ]);

                // ‚úÖ Converte os extintores mais rapidamente
                extintores = extintoresSnap.exists()
                    ? Object.entries(extintoresSnap.val()).map(([id, data]) => ({ id, ...data }))
                    : [];

                // ‚úÖ Converte o hist√≥rico em um objeto indexado por ID
                historico = historicoSnap.exists()
                    ? Object.entries(historicoSnap.val()).reduce((acc, [_, item]) => {
                        acc[item.extintorId] = item.entries || [];
                        return acc;
                    }, {})
                    : {};

                console.log(`‚úÖ ${extintores.length} extintores carregados do Firebase`);
                return { extintores, historico };

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do Firebase:', error);
                throw error;
            }
        }


        async function saveExtintorToFirebase(extintorData) {
            try {
                const extintoresRef = window.ref(window.database, 'extintores');
                const newExtintorRef = window.push(extintoresRef);
                await window.set(newExtintorRef, extintorData);
                return newExtintorRef.key;
            } catch (error) {
                console.error('Erro ao salvar extintor:', error);
                throw error;
            }
        }

        async function updateExtintorInFirebase(id, extintorData) {
            try {
                const extintorRef = window.ref(window.database, `extintores/${id}`);
                await window.update(extintorRef, extintorData);
            } catch (error) {
                console.error('Erro ao atualizar extintor:', error);
                throw error;
            }
        }

        async function deleteExtintorFromFirebase(id) {
            try {
                // Deletar extintor
                const extintorRef = window.ref(window.database, `extintores/${id}`);
                await window.remove(extintorRef);

                // Deletar hist√≥rico relacionado
                const historicoRef = window.ref(window.database, 'historico');
                const historicoSnapshot = await window.get(historicoRef);

                if (historicoSnapshot.exists()) {
                    const data = historicoSnapshot.val();
                    Object.keys(data).forEach(async (key) => {
                        if (data[key].extintorId === id) {
                            const historicoItemRef = window.ref(window.database, `historico/${key}`);
                            await window.remove(historicoItemRef);
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao deletar extintor:', error);
                throw error;
            }
        }

        async function saveHistoricoToFirebase(extintorId, historicoEntries) {
            try {
                // Buscar se j√° existe hist√≥rico para este extintor
                const historicoRef = window.ref(window.database, 'historico');
                const snapshot = await window.get(historicoRef);

                let historicoKey = null;

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        if (data[key].extintorId === extintorId) {
                            historicoKey = key;
                        }
                    });
                }

                if (historicoKey) {
                    // Atualizar hist√≥rico existente
                    const historicoItemRef = window.ref(window.database, `historico/${historicoKey}`);
                    await window.update(historicoItemRef, {
                        entries: historicoEntries
                    });
                } else {
                    // Criar novo hist√≥rico
                    const newHistoricoRef = window.push(historicoRef);
                    await window.set(newHistoricoRef, {
                        extintorId: extintorId,
                        entries: historicoEntries
                    });
                }
            } catch (error) {
                console.error('Erro ao salvar hist√≥rico:', error);
                throw error;
            }
        }

        function initializeDefaultData() {
            const defaultExtintores = [
                // TODOS OS EXTINTORES ORIGINAIS DO SISTEMA (1-50)
                // TODOS OS EXTINTORES ORIGINAIS DO SISTEMA (1-50)
                { id: 'ext_001', numero: '1', localizacao: 'Portaria', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_002', numero: '2', localizacao: 'Cabine Prim√°ria', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_003', numero: '3', localizacao: 'Cabine Prim√°ria', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_004', numero: '4', localizacao: 'Cabine G√°s', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_005', numero: '5', localizacao: 'Cabine Secund√°ria', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_006', numero: '6', localizacao: 'Recep√ß√£o', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_007', numero: '7', localizacao: 'Sala Diretor', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_008', numero: '8', localizacao: 'Sala Ger√™ncia', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_009', numero: '9', localizacao: 'Refeit√≥rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_010', numero: '10', localizacao: 'Cozinha', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_011', numero: '11', localizacao: 'Porta Almoxarifado', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_012', numero: '12', localizacao: 'Almoxarifado', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_013', numero: '13', localizacao: 'M√°q. Seladora', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_014', numero: '14', localizacao: 'Setor Nylon (Final)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_015', numero: '15', localizacao: 'Setor Nylon (Caf√©)', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_016', numero: '16', localizacao: 'Pr√≥x. Arm√°rio', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_017', numero: '17', localizacao: 'Pr√≥x. Arm√°rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_018', numero: '18', localizacao: 'Sala (Chiller)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_019', numero: '19', localizacao: 'Sala (Chiller)', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_020', numero: '20', localizacao: 'Pr√≥x. Laborat√≥rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_021', numero: '21', localizacao: 'Pr√≥x. Escada (Sa√≠da)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_022', numero: '22', localizacao: 'Corredor Extrusora', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_023', numero: '23', localizacao: 'Ao lado extrusora bal√£o', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_024', numero: '24', localizacao: 'Pr√≥x. Escada (Bal√£o)', carga: 'P√≥', tipo: 'CO2', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_025', numero: '25', localizacao: 'Pr√≥x. Banheiro (GI)', carga: 'P√≥', tipo: 'CO2', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_026', numero: '26', localizacao: 'Estoque (Carga e Descarga)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_027', numero: '27', localizacao: 'Estoque (Carga e Descarga)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_028', numero: '28', localizacao: 'Sala Contra Mestre', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_029', numero: '29', localizacao: 'Sala Manuten√ß√£o', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_030', numero: '30', localizacao: 'Porta Manuten√ß√£o', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_031', numero: '31', localizacao: 'Lado direito GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_032', numero: '32', localizacao: 'Estoque (Fundo GI)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_033', numero: '33', localizacao: 'Estoque (Fundo GI)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_034', numero: '34', localizacao: 'Lado direito GI (Fundo)', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_035', numero: '35', localizacao: 'Lado esquerdo GI', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_036', numero: '36', localizacao: 'Lado esquerdo GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                { id: 'ext_037', numero: '37', localizacao: 'Escada lado esquerdo GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },

            ];

            extintores = defaultExtintores;

            // Criar hist√≥rico inicial para cada extintor
            historico = {};
            defaultExtintores.forEach(extintor => {
                historico[extintor.id] = [{
                    data: '2024-11-21',
                    tipo: 'cadastro',
                    responsavel: 'Sistema',
                    observacao: 'Extintor cadastrado no sistema',
                    detalhes: {
                        ultimaManutencao: extintor.ultimaManutencao,
                        proximaManutencao: extintor.proximaManutencao,
                        status: 'Em dia'
                    }
                }];
            });

            // Salvar no localStorage
            saveToLocalStorage();

            console.log('Dados padr√£o inicializados localmente');
        }

        async function addDefaultData() {
            try {
                const defaultExtintores = [
                    // TODOS OS EXTINTORES ORIGINAIS DO SISTEMA (1-50)
                    { numero: '1', localizacao: 'Portaria', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '2', localizacao: 'Cabine Prim√°ria', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '3', localizacao: 'Cabine Prim√°ria', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '4', localizacao: 'Cabine G√°s', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '5', localizacao: 'Cabine Secund√°ria', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '6', localizacao: 'Recep√ß√£o', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '7', localizacao: 'Sala Diretor', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '8', localizacao: 'Sala Ger√™ncia', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '9', localizacao: 'Refeit√≥rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '10', localizacao: 'Cozinha', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '11', localizacao: 'Porta Almoxarifado', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '12', localizacao: 'Almoxarifado', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '13', localizacao: 'M√°q. Seladora', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '14', localizacao: 'Setor Nylon (Final)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '15', localizacao: 'Setor Nylon (Caf√©)', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '16', localizacao: 'Pr√≥x. Arm√°rio', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '17', localizacao: 'Pr√≥x. Arm√°rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '18', localizacao: 'Sala (Chiller)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '19', localizacao: 'Sala (Chiller)', carga: 'P√≥', tipo: 'CO2', kg: '6', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '20', localizacao: 'Pr√≥x. Laborat√≥rio', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '21', localizacao: 'Pr√≥x. Escada (Sa√≠da)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '22', localizacao: 'Corredor Extrusora', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '23', localizacao: 'Ao lado extrusora bal√£o', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '24', localizacao: 'Pr√≥x. Escada (Bal√£o)', carga: 'P√≥', tipo: 'CO2', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '25', localizacao: 'Pr√≥x. Banheiro (GI)', carga: 'P√≥', tipo: 'CO2', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '26', localizacao: 'Estoque (Carga e Descarga)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '27', localizacao: 'Estoque (Carga e Descarga)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '28', localizacao: 'Sala Contra Mestre', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '29', localizacao: 'Sala Manuten√ß√£o', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '30', localizacao: 'Porta Manuten√ß√£o', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '31', localizacao: 'Lado direito GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '32', localizacao: 'Estoque (Fundo GI)', carga: 'P√≥', tipo: 'P√≥ Qu√≠mico', kg: '4', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '33', localizacao: 'Estoque (Fundo GI)', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '34', localizacao: 'Lado direito GI (Fundo)', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '35', localizacao: 'Lado esquerdo GI', carga: 'P√≥', tipo: 'BC', kg: '4', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '36', localizacao: 'Lado esquerdo GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2024-11-21', proximaManutencao: '2025-11-21', observacao: '', responsavel: '', emManutencao: 'false' },
                    { numero: '37', localizacao: 'Escada lado esquerdo GI', carga: '√Ågua', tipo: '√Ågua', kg: '10', lacrado: 'Sim', ultimaManutencao: '2025-03-21', proximaManutencao: '2026-03-21', observacao: '', responsavel: '', emManutencao: 'false' }
                ];

                // Salvar no Firebase Realtime Database
                const extintoresRef = window.ref(window.database, 'extintores');
                const historicoRef = window.ref(window.database, 'historico');

                for (const extintor of defaultExtintores) {
                    const { id, ...extintorData } = extintor; // Remove o ID local

                    // Salvar extintor
                    const newExtintorRef = window.push(extintoresRef);
                    await window.set(newExtintorRef, extintorData);

                    // Criar hist√≥rico inicial
                    const newHistoricoRef = window.push(historicoRef);
                    await window.set(newHistoricoRef, {
                        extintorId: newExtintorRef.key,
                        entries: [{
                            data: '2024-11-21',
                            tipo: 'manutencao',
                            responsavel: 'Sistema',
                            observacao: 'Cadastro inicial do extintor',
                            detalhes: {
                                ultimaManutencao: extintor.ultimaManutencao,
                                proximaManutencao: extintor.proximaManutencao,
                                status: 'Em dia'
                            }
                        }]
                    });
                }

                console.log('Dados padr√£o adicionados ao Firebase Realtime Database');
            } catch (error) {
                console.error('Erro ao adicionar dados padr√£o:', error);
                throw error;
            }
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterExtintores);
            document.getElementById('filterTipo').addEventListener('change', filterExtintores);
            document.getElementById('filterStatus').addEventListener('change', filterExtintores);

            document.getElementById('extintorForm').addEventListener('submit', function (e) {
                e.preventDefault();
                saveExtintor();
            });

            // Auto-calcular pr√≥xima manuten√ß√£o
            document.getElementById('ultimaManutencao').addEventListener('change', function () {
                const ultimaData = new Date(this.value);
                if (ultimaData) {
                    const proximaData = new Date(ultimaData);
                    proximaData.setFullYear(proximaData.getFullYear() + 1);
                    document.getElementById('proximaManutencao').value = proximaData.toISOString().split('T')[0];
                }
            });
        }

        function openModal(id = null) {
            editingId = id;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const historicoSection = document.getElementById('historicoSection');

            if (id) {
                title.textContent = 'Editar Extintor';
                const extintor = extintores.find(e => e.id === id);
                fillForm(extintor);
                historicoSection.classList.remove('hidden');
                loadHistorico(id);
            } else {
                title.textContent = 'Novo Extintor';
                document.getElementById('extintorForm').reset();
                historicoSection.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            editingId = null;
        }

        function fillForm(extintor) {
            document.getElementById('numero').value = extintor.numero;
            document.getElementById('localizacao').value = extintor.localizacao;
            document.getElementById('carga').value = extintor.carga;
            document.getElementById('tipo').value = extintor.tipo;
            document.getElementById('kg').value = extintor.kg;
            document.getElementById('lacrado').value = extintor.lacrado;
            document.getElementById('emManutencao').value = extintor.emManutencao || 'false';
            document.getElementById('ultimaManutencao').value = extintor.ultimaManutencao;
            document.getElementById('proximaManutencao').value = extintor.proximaManutencao;
            document.getElementById('observacao').value = extintor.observacao || '';
            document.getElementById('responsavel').value = extintor.responsavel || '';
        }

        async function saveExtintor() {
            try {
                const formData = {
                    numero: document.getElementById('numero').value,
                    localizacao: document.getElementById('localizacao').value,
                    carga: document.getElementById('carga').value,
                    tipo: document.getElementById('tipo').value,
                    kg: document.getElementById('kg').value,
                    lacrado: document.getElementById('lacrado').value,
                    emManutencao: document.getElementById('emManutencao').value,
                    ultimaManutencao: document.getElementById('ultimaManutencao').value,
                    proximaManutencao: document.getElementById('proximaManutencao').value,
                    observacao: document.getElementById('observacao').value,
                    responsavel: document.getElementById('responsavel').value
                };

                const agora = new Date().toISOString().split('T')[0];
                const agoraHora = new Date().toLocaleString('pt-BR');

                if (editingId) {
                    // Atualizar extintor existente
                    const extintorAntigo = extintores.find(e => e.id === editingId);

                    // Tentar salvar no Firebase primeiro
                    if (firebaseReady) {
                        try {
                            await updateExtintorInFirebase(editingId, formData);
                        } catch (error) {
                            console.warn('Erro ao salvar no Firebase, salvando localmente:', error);
                        }
                    }

                    // Atualizar localmente
                    const index = extintores.findIndex(e => e.id === editingId);
                    extintores[index] = { ...formData, id: editingId };
                    saveToLocalStorage();

                    // Registrar altera√ß√µes no hist√≥rico
                    const alteracoes = [];
                    if (extintorAntigo.ultimaManutencao !== formData.ultimaManutencao) {
                        alteracoes.push(`Manuten√ß√£o atualizada: ${new Date(formData.ultimaManutencao).toLocaleDateString('pt-BR')}`);
                    }
                    if (extintorAntigo.lacrado !== formData.lacrado) {
                        alteracoes.push(`Lacre alterado: ${formData.lacrado}`);
                    }
                    if (extintorAntigo.observacao !== formData.observacao) {
                        alteracoes.push(`Observa√ß√£o atualizada`);
                    }

                    if (alteracoes.length > 0) {
                        await addHistoricoEntry(editingId, {
                            data: agora,
                            hora: agoraHora,
                            tipo: 'edicao',
                            responsavel: formData.responsavel || 'Sistema',
                            observacao: `Extintor editado: ${alteracoes.join(', ')}`,
                            detalhes: {
                                ultimaManutencao: formData.ultimaManutencao,
                                proximaManutencao: formData.proximaManutencao,
                                status: getStatusText(getStatus(formData.proximaManutencao))
                            }
                        });
                    }

                    showNotification('‚úÖ Extintor Atualizado!', `Extintor #${formData.numero} foi atualizado com sucesso`, 'success');
                } else {
                    // Criar novo extintor
                    let docId;

                    if (firebaseReady) {
                        try {
                            docId = await saveExtintorToFirebase(formData);
                        } catch (error) {
                            console.warn('Erro ao salvar no Firebase, gerando ID local:', error);
                            docId = 'ext_' + Date.now();
                        }
                    } else {
                        docId = 'ext_' + Date.now();
                    }

                    // Adicionar localmente
                    const newExtintor = { ...formData, id: docId };
                    extintores.push(newExtintor);
                    saveToLocalStorage();

                    // Criar hist√≥rico inicial
                    await addHistoricoEntry(docId, {
                        data: agora,
                        hora: agoraHora,
                        tipo: 'cadastro',
                        responsavel: formData.responsavel || 'Sistema',
                        observacao: 'Extintor cadastrado no sistema',
                        detalhes: {
                            ultimaManutencao: formData.ultimaManutencao,
                            proximaManutencao: formData.proximaManutencao,
                            status: getStatusText(getStatus(formData.proximaManutencao))
                        }
                    });

                    showNotification('‚úÖ Extintor Cadastrado!', `Extintor #${formData.numero} foi cadastrado com sucesso`, 'success');
                }

                loadExtintores();
                updateDashboard();
                checkProximasManutencoes();
                closeModal();
            } catch (error) {
                console.error('Erro ao salvar extintor:', error);
                showNotification('‚ùå Erro ao Salvar', 'N√£o foi poss√≠vel salvar o extintor. Tente novamente.', 'error');
            }
        }

        async function addHistoricoEntry(extintorId, entry) {
            try {
                if (!historico[extintorId]) {
                    historico[extintorId] = [];
                }
                historico[extintorId].unshift(entry); // Adiciona no in√≠cio para ordem cronol√≥gica reversa

                // Salvar localmente sempre
                saveToLocalStorage();

                // Tentar salvar no Firebase se dispon√≠vel
                if (firebaseReady) {
                    try {
                        await saveHistoricoToFirebase(extintorId, historico[extintorId]);
                    } catch (error) {
                        console.warn('Erro ao salvar hist√≥rico no Firebase:', error);
                    }
                }
            } catch (error) {
                console.error('Erro ao adicionar entrada no hist√≥rico:', error);
            }
        }

        function loadHistorico(extintorId) {
            const historicoContent = document.getElementById('historicoContent');
            const extintorHistorico = historico[extintorId] || [];

            if (extintorHistorico.length === 0) {
                historicoContent.innerHTML = '<p class="text-gray-400 text-sm">Nenhum hist√≥rico encontrado</p>';
                return;
            }

            historicoContent.innerHTML = extintorHistorico.map(entry => {
                let iconClass = 'fas fa-info-circle text-blue-400';
                let timelineClass = '';

                switch (entry.tipo) {
                    case 'manutencao':
                        iconClass = 'fas fa-wrench text-green-400';
                        timelineClass = 'success';
                        break;
                    case 'cadastro':
                        iconClass = 'fas fa-plus-circle text-blue-400';
                        break;
                    case 'edicao':
                        iconClass = 'fas fa-edit text-yellow-400';
                        timelineClass = 'warning';
                        break;
                    case 'alerta':
                        iconClass = 'fas fa-exclamation-triangle text-red-400';
                        break;
                }

                return `
                    <div class="timeline-item ${timelineClass}">
                        <div class="flex items-start space-x-3">
                            <i class="${iconClass}"></i>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-white font-semibold text-sm">${entry.responsavel}</span>
                                    <span class="text-gray-400 text-xs">${new Date(entry.data).toLocaleDateString('pt-BR')}</span>
                                </div>
                                <p class="text-gray-300 text-sm mb-2">${entry.observacao}</p>
                                ${entry.detalhes ? `
                                    <div class="bg-gray-700 bg-opacity-50 p-2 rounded text-xs">
                                        <div class="text-gray-400">Status: <span class="text-white">${entry.detalhes.status}</span></div>
                                        <div class="text-gray-400">Pr√≥xima: <span class="text-white">${new Date(entry.detalhes.proximaManutencao).toLocaleDateString('pt-BR')}</span></div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openHistoricoModal(extintorId) {
            const modal = document.getElementById('historicoModal');
            const content = document.getElementById('historicoModalContent');
            const extintor = extintores.find(e => e.id === extintorId);
            const extintorHistorico = historico[extintorId] || [];

            content.innerHTML = `
                <div class="mb-4 p-4 bg-gray-700 bg-opacity-50 rounded-lg">
                    <h3 class="text-white font-bold">Extintor #${extintor.numero} - ${extintor.localizacao}</h3>
                    <p class="text-gray-300 text-sm">${extintor.tipo} ‚Ä¢ ${extintor.kg}kg</p>
                </div>
                
                <div class="space-y-4">
                    ${extintorHistorico.length === 0 ?
                    '<p class="text-gray-400 text-center">Nenhum hist√≥rico encontrado</p>' :
                    extintorHistorico.map(entry => {
                        let iconClass = 'fas fa-info-circle text-blue-400';
                        let bgClass = 'bg-gray-700';

                        switch (entry.tipo) {
                            case 'manutencao':
                                iconClass = 'fas fa-wrench text-green-400';
                                bgClass = 'bg-green-900 bg-opacity-30';
                                break;
                            case 'cadastro':
                                iconClass = 'fas fa-plus-circle text-blue-400';
                                bgClass = 'bg-blue-900 bg-opacity-30';
                                break;
                            case 'edicao':
                                iconClass = 'fas fa-edit text-yellow-400';
                                bgClass = 'bg-yellow-900 bg-opacity-30';
                                break;
                            case 'alerta':
                                iconClass = 'fas fa-exclamation-triangle text-red-400';
                                bgClass = 'bg-red-900 bg-opacity-30';
                                break;
                        }

                        return `
                                <div class="${bgClass} p-4 rounded-lg">
                                    <div class="flex items-start space-x-3">
                                        <i class="${iconClass} text-lg"></i>
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start mb-2">
                                                <span class="text-white font-semibold">${entry.responsavel}</span>
                                                <span class="text-gray-400 text-sm">${entry.hora || new Date(entry.data).toLocaleDateString('pt-BR')}</span>
                                            </div>
                                            <p class="text-gray-300 mb-3">${entry.observacao}</p>
                                            ${entry.detalhes ? `
                                                <div class="bg-black bg-opacity-20 p-3 rounded">
                                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                                        <div class="text-gray-400">Status: <span class="text-white">${entry.detalhes.status}</span></div>
                                                        <div class="text-gray-400">Pr√≥xima: <span class="text-white">${new Date(entry.detalhes.proximaManutencao).toLocaleDateString('pt-BR')}</span></div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                    }).join('')
                }
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHistoricoModal() {
            document.getElementById('historicoModal').classList.add('hidden');
            document.getElementById('historicoModal').classList.remove('flex');
        }

        function deleteExtintor(id) {
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');

            document.getElementById('confirmDelete').onclick = async function () {
                try {
                    const extintor = extintores.find(e => e.id === id);

                    // Deletar do Firebase
                    await deleteExtintorFromFirebase(id);

                    // Remover localmente
                    extintores = extintores.filter(e => e.id !== id);
                    delete historico[id];

                    loadExtintores();
                    updateDashboard();
                    closeDeleteModal();

                    showNotification('‚úÖ Extintor Exclu√≠do!', `Extintor #${extintor?.numero || '?'} foi exclu√≠do com sucesso`, 'success');
                } catch (error) {
                    console.error('Erro ao excluir extintor:', error);
                    showNotification('‚ùå Erro ao Excluir', 'N√£o foi poss√≠vel excluir o extintor. Tente novamente.', 'error');
                    closeDeleteModal();
                }
            };
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
        }

        function getStatus(proximaManutencao) {
            const hoje = new Date();
            const proxima = new Date(proximaManutencao);
            const diffTime = proxima - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'vencido';
            if (diffDays <= 30) return 'proximo';
            return 'ok';
        }

        function getStatusText(status) {
            switch (status) {
                case 'vencido': return 'Vencido';
                case 'proximo': return 'Pr√≥ximo';
                case 'ok': return 'Em Dia';
                default: return 'Indefinido';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'vencido': return 'status-vencido';
                case 'proximo': return 'status-proximo';
                case 'ok': return 'status-ok';
                default: return 'bg-gray-500';
            }
        }

        function getDiasRestantes(proximaManutencao) {
            const hoje = new Date();
            const proxima = new Date(proximaManutencao);
            const diffTime = proxima - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function setView(view) {
            currentView = view;
            document.getElementById('viewCards').className = view === 'cards' ?
                'btn-primary px-4 py-3 rounded-lg font-semibold' :
                'bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg font-semibold transition-all';
            document.getElementById('viewList').className = view === 'list' ?
                'btn-primary px-4 py-3 rounded-lg font-semibold' :
                'bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg font-semibold transition-all';
            loadExtintores();
        }

        function updateAllToMaintenance() {
            const today = new Date().toISOString().split('T')[0];
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            const nextYearDate = nextYear.toISOString().split('T')[0];
            const agoraHora = new Date().toLocaleString('pt-BR');

            extintores.forEach(extintor => {
                extintor.ultimaManutencao = today;
                extintor.proximaManutencao = nextYearDate;
                extintor.observacao = 'Manuten√ß√£o realizada';

                // Adicionar ao hist√≥rico
                addHistoricoEntry(extintor.id, {
                    data: today,
                    hora: agoraHora,
                    tipo: 'manutencao',
                    responsavel: 'Sistema - Manuten√ß√£o em Lote',
                    observacao: 'Manuten√ß√£o preventiva realizada em todos os extintores',
                    detalhes: {
                        ultimaManutencao: today,
                        proximaManutencao: nextYearDate,
                        status: 'Em dia'
                    }
                });
            });

            localStorage.setItem('extintores', JSON.stringify(extintores));
            localStorage.setItem('historico', JSON.stringify(historico));
            loadExtintores();
            updateDashboard();
             showNotification(' Modo Manuten√ß√£o ', `Todos extintores est√£o em dia`, 'info');
        }

        function updateAllToOk() {
            const nextMaintenance = '2025-11-21';
            const agoraHora = new Date().toLocaleString('pt-BR');

            extintores.forEach(extintor => {
                // Atualizar TODOS os extintores, incluindo o n√∫mero 4
                extintor.ultimaManutencao = '2024-11-21';
                extintor.proximaManutencao = nextMaintenance;
                extintor.observacao = '';
                extintor.emManutencao = 'false'; // Garantir que saia do modo manuten√ß√£o

                // Adicionar ao hist√≥rico
                addHistoricoEntry(extintor.id, {
                    data: '2024-11-21',
                    hora: agoraHora,
                    tipo: 'manutencao',
                    responsavel: 'Sistema - Atualiza√ß√£o em Lote',
                    observacao: 'Status atualizado para "Em dia"',
                    detalhes: {
                        ultimaManutencao: '2024-11-21',
                        proximaManutencao: nextMaintenance,
                        status: 'Em dia'
                    }
                });
            });

            localStorage.setItem('extintores', JSON.stringify(extintores));
            localStorage.setItem('historico', JSON.stringify(historico));
            loadExtintores();
            updateDashboard();
        }

        function loadExtintores() {
            const container = document.getElementById('extintoresList');
            const filteredExtintores = getFilteredExtintores();

            if (filteredExtintores.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-fire-extinguisher text-6xl text-gray-500 mb-4"></i>
                        <p class="text-xl text-gray-400">Nenhum extintor encontrado</p>
                        <p class="text-gray-500">Adicione um novo extintor para come√ßar</p>
                    </div>
                `;
                return;
            }

            if (currentView === 'list') {
                container.className = 'w-full';
                container.innerHTML = `
                    <div class="card-gradient rounded-xl overflow-hidden shadow-2xl">
                        <div class="bg-gradient-to-r from-red-600 via-red-700 to-red-800 p-4">
                            <h3 class="text-white font-bold text-lg flex items-center">
                                <i class="fas fa-list-ul mr-3"></i>
                                Lista Completa de Extintores (${filteredExtintores.length} itens)
                            </h3>
                        </div>
                        <div class="w-full">
                            <!-- Mobile: Cards em lista -->
                            <div class="block md:hidden space-y-4">
                                ${filteredExtintores.map((extintor, index) => {
                    const status = getStatus(extintor.proximaManutencao);
                    const statusText = getStatusText(status);
                    const diasRestantes = getDiasRestantes(extintor.proximaManutencao);

                    let statusBadge = '';
                    let cardClass = '';

                    if (status === 'vencido') {
                        statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>VENCIDO
                                        </span>`;
                        cardClass = 'border-l-4 border-red-500 bg-red-900 bg-opacity-10';
                    } else if (status === 'proximo') {
                        statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">
                                            <i class="fas fa-clock mr-1"></i>${diasRestantes}D
                                        </span>`;
                        cardClass = 'border-l-4 border-yellow-500 bg-yellow-900 bg-opacity-10';
                    } else {
                        statusBadge = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                            <i class="fas fa-check-circle mr-1"></i>OK
                                        </span>`;
                        cardClass = 'border-l-4 border-green-500 bg-green-900 bg-opacity-10';
                    }

                    return `
                                        <div class="card-gradient p-4 rounded-lg ${cardClass}">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                        ${extintor.numero}
                                                    </div>
                                                    <div>
                                                        <h3 class="text-white font-bold text-sm">${extintor.localizacao}</h3>
                                                        <p class="text-gray-400 text-xs">${extintor.tipo} ‚Ä¢ ${extintor.kg}kg</p>
                                                    </div>
                                                </div>
                                                ${statusBadge}
                                            </div>
                                            
                                            <div class="grid grid-cols-2 gap-3 mb-3 text-xs">
                                                <div>
                                                    <span class="text-gray-400">Carga:</span>
                                                    <span class="text-white ml-1">${extintor.carga}</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-400">Lacre:</span>
                                                    <span class="text-white ml-1 ${extintor.lacrado === 'Sim' ? 'text-green-400' : 'text-red-400'}">
                                                        <i class="fas ${extintor.lacrado === 'Sim' ? 'fa-lock' : 'fa-unlock'} mr-1"></i>
                                                        ${extintor.lacrado}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-400">√öltima:</span>
                                                    <span class="text-white ml-1">${new Date(extintor.ultimaManutencao).toLocaleDateString('pt-BR')}</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-400">Pr√≥xima:</span>
                                                    <span class="text-white ml-1">${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}</span>
                                                </div>
                                            </div>
                                            
                                            <div class="flex justify-between items-center">
                                                <button onclick="toggleManutencao('${extintor.id}')" 
                                                        class="${extintor.emManutencao === 'true' ? 'btn-maintenance-active' : 'btn-maintenance'} px-3 py-1 rounded text-xs font-semibold transition-all">
                                                    <i class="fas ${extintor.emManutencao === 'true' ? 'fa-tools' : 'fa-wrench'} mr-1"></i>
                                                    ${extintor.emManutencao === 'true' ? 'Concluir' : 'Manuten√ß√£o'}
                                                </button>
                                                
                                                <div class="flex space-x-1">
                                                    <button onclick="openHistoricoModal('${extintor.id}')" 
                                                            class="bg-purple-600 hover:bg-purple-700 p-2 rounded transition-all"
                                                            title="Hist√≥rico">
                                                        <i class="fas fa-history text-white text-xs"></i>
                                                    </button>
                                                    <button onclick="downloadQRCode('${extintor.id}')" 
                                                            class="bg-green-600 hover:bg-green-700 p-2 rounded transition-all"
                                                            title="QR Code">
                                                        <i class="fas fa-qrcode text-white text-xs"></i>
                                                    </button>
                                                    <button onclick="openModal('${extintor.id}')" 
                                                            class="bg-blue-600 hover:bg-blue-700 p-2 rounded transition-all"
                                                            title="Editar">
                                                        <i class="fas fa-edit text-white text-xs"></i>
                                                    </button>
                                                    <button onclick="deleteExtintor('${extintor.id}')" 
                                                            class="bg-red-600 hover:bg-red-700 p-2 rounded transition-all"
                                                            title="Excluir">
                                                        <i class="fas fa-trash text-white text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                }).join('')}
                            </div>
                            
                            <!-- Desktop: Tabela -->
                            <div class="hidden md:block overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-800 border-b border-gray-600">
                                        <tr>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm">
                                                <i class="fas fa-hashtag mr-2"></i>N¬∫
                                            </th>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm">
                                                <i class="fas fa-map-marker-alt mr-2"></i>Localiza√ß√£o
                                            </th>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm">
                                                <i class="fas fa-tag mr-2"></i>Tipo/Peso
                                            </th>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm hidden lg:table-cell">
                                                <i class="fas fa-battery-full mr-2"></i>Carga/Lacre
                                            </th>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm">
                                                <i class="fas fa-heartbeat mr-2"></i>Status
                                            </th>
                                            <th class="px-4 py-4 text-left text-white font-semibold text-sm">
                                                <i class="fas fa-calendar-alt mr-2"></i>Manuten√ß√£o
                                            </th>
                                            <th class="px-4 py-4 text-center text-white font-semibold text-sm">
                                                <i class="fas fa-cogs mr-2"></i>A√ß√µes
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredExtintores.map((extintor, index) => {
                    const status = getStatus(extintor.proximaManutencao);
                    const statusText = getStatusText(status);
                    const diasRestantes = getDiasRestantes(extintor.proximaManutencao);

                    let statusBadge = '';
                    let rowClass = '';

                    if (status === 'vencido') {
                        statusBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-800">
                                                    <i class="fas fa-exclamation-triangle mr-1"></i>VENCIDO
                                                </span>`;
                        rowClass = 'bg-red-900 bg-opacity-20 border-l-4 border-red-500';
                    } else if (status === 'proximo') {
                        statusBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800">
                                                    <i class="fas fa-clock mr-1"></i>${diasRestantes} DIAS
                                                </span>`;
                        rowClass = 'bg-yellow-900 bg-opacity-20 border-l-4 border-yellow-500';
                    } else {
                        statusBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                                                    <i class="fas fa-check-circle mr-1"></i>EM DIA
                                                </span>`;
                        rowClass = index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-750';
                    }

                    return `
                                                <tr class="${rowClass} hover:bg-gray-600 transition-all duration-200">
                                                    <td class="px-4 py-4">
                                                        <div class="flex items-center">
                                                            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                                                ${extintor.numero}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <div class="text-white font-semibold text-sm">${extintor.localizacao}</div>
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <div class="text-gray-300 text-sm font-medium">${extintor.tipo}</div>
                                                        <div class="text-gray-400 text-xs">${extintor.kg}kg</div>
                                                    </td>
                                                    <td class="px-4 py-4 hidden lg:table-cell">
                                                        <div class="text-gray-300 text-sm">${extintor.carga}</div>
                                                        <div class="text-xs ${extintor.lacrado === 'Sim' ? 'text-green-400' : 'text-red-400'}">
                                                            <i class="fas ${extintor.lacrado === 'Sim' ? 'fa-lock' : 'fa-unlock'} mr-1"></i>
                                                            ${extintor.lacrado}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        ${statusBadge}
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <div class="text-gray-300 text-sm">
                                                            ${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}
                                                        </div>
                                                        <div class="text-xs text-gray-400">
                                                            √ölt: ${new Date(extintor.ultimaManutencao).toLocaleDateString('pt-BR')}
                                                        </div>
                                                    </td>
                                                    <td class="px-4 py-4">
                                                        <div class="flex justify-center space-x-1">
                                                            <button onclick="toggleManutencao('${extintor.id}')" 
                                                                    class="${extintor.emManutencao === 'true' ? 'btn-maintenance-active' : 'btn-maintenance'} p-2 rounded transition-all"
                                                                    title="${extintor.emManutencao === 'true' ? 'Concluir Manuten√ß√£o' : 'Marcar Manuten√ß√£o'}">
                                                                <i class="fas ${extintor.emManutencao === 'true' ? 'fa-tools' : 'fa-wrench'} text-white text-xs"></i>
                                                            </button>
                                                            <button onclick="openHistoricoModal('${extintor.id}')" 
                                                                    class="bg-purple-600 hover:bg-purple-700 p-2 rounded transition-all"
                                                                    title="Ver hist√≥rico">
                                                                <i class="fas fa-history text-white text-xs"></i>
                                                            </button>
                                                            <button onclick="downloadQRCode('${extintor.id}')" 
                                                                    class="bg-green-600 hover:bg-green-700 p-2 rounded transition-all"
                                                                    title="Baixar QR Code">
                                                                <i class="fas fa-qrcode text-white text-xs"></i>
                                                            </button>
                                                            <button onclick="openModal('${extintor.id}')" 
                                                                    class="bg-blue-600 hover:bg-blue-700 p-2 rounded transition-all"
                                                                    title="Editar extintor">
                                                                <i class="fas fa-edit text-white text-xs"></i>
                                                            </button>
                                                            <button onclick="deleteExtintor('${extintor.id}')" 
                                                                    class="bg-red-600 hover:bg-red-700 p-2 rounded transition-all"
                                                                    title="Excluir extintor">
                                                                <i class="fas fa-trash text-white text-xs"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Melhoria de layout, espa√ßamento e barra de rolagem
                container.className = `
  cards-container grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6
  overflow-y-auto p-6
  scrollbar-thin scrollbar-thumb-rounded-lg scrollbar-thumb-gray-600 scrollbar-track-gray-800
`;
                container.style.maxHeight = "calc(100vh - 180px)";
                container.style.scrollBehavior = "smooth";

                container.innerHTML = filteredExtintores.map(extintor => {
                    const status = getStatus(extintor.proximaManutencao);
                    const statusText = getStatusText(status);
                    const statusClass = getStatusClass(status);
                    const diasRestantes = getDiasRestantes(extintor.proximaManutencao);

                    let statusInfo = '';
                    let urgencyIcon = '';

                    if (status === 'vencido') {
                        statusInfo = `<div class="text-red-200 text-xs font-semibold">‚ö†Ô∏è A√á√ÉO NECESS√ÅRIA</div>`;
                        urgencyIcon = '<i class="fas fa-exclamation-triangle text-red-300 animate-pulse"></i>';
                    } else if (status === 'proximo') {
                        statusInfo = `<div class="text-yellow-200 text-xs font-semibold">üîî ${diasRestantes} dias restantes</div>`;
                        urgencyIcon = '<i class="fas fa-clock text-yellow-300"></i>';
                    } else {
                        statusInfo = `<div class="text-green-200 text-xs font-semibold">‚úÖ Situa√ß√£o regular</div>`;
                        urgencyIcon = '<i class="fas fa-check-circle text-green-300"></i>';
                    }

                    return `
        <div class="extintor-card rounded-2xl shadow-lg bg-gray-900 bg-opacity-70 border border-gray-700 hover:shadow-2xl hover:border-gray-600 transition-all duration-300">
            
            <div class="qr-code-container p-3 flex justify-center" id="qr-${extintor.id}">
                <!-- QR Code ser√° gerado aqui -->
            </div>
            
            <div class="${extintor.emManutencao === 'true' ? 'bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800' : statusClass} card-header p-4 rounded-t-2xl flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center space-x-2">
                        <i class="fas fa-fire-extinguisher"></i>
                        <span>Extintor #${extintor.numero}</span>
                        ${extintor.emManutencao === 'true' ? `
                            <span class="ml-2 bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-bold">
                                üîß 
                            </span>` : ''
                        }
                    </h3>
                    ${extintor.emManutencao === 'true'
                            ? `<div class="text-blue-100 text-xs font-semibold mt-1">üîß Em processo de manuten√ß√£o</div>`
                            : statusInfo
                        }
                </div>
                <div class="flex flex-col items-center space-y-1">
                    ${extintor.emManutencao === 'true'
                            ? '<i class="fas fa-tools text-blue-200 text-xl animate-pulse"></i>'
                            : urgencyIcon
                        }
                </div>
            </div>

            <div class="card-content p-5 space-y-5">
                <div class="info-grid space-y-4">
                    <div>
                        <div class="flex items-center space-x-2 mb-1 text-gray-400 text-sm font-semibold">
                            <i class="fas fa-map-marker-alt text-red-400"></i>
                            <span>Localiza√ß√£o</span>
                        </div>
                        <div class="text-gray-200 text-sm">${extintor.localizacao}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center space-x-2 mb-1 text-gray-400 text-sm font-semibold">
                                <i class="fas fa-tag text-blue-400"></i>
                                <span>Tipo</span>
                            </div>
                            <div class="text-gray-200 text-sm">${extintor.tipo}</div>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2 mb-1 text-gray-400 text-sm font-semibold">
                                <i class="fas fa-weight text-purple-400"></i>
                                <span>Peso</span>
                            </div>
                            <div class="text-gray-200 text-sm">${extintor.kg}kg</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center space-x-2 mb-1 text-gray-400 text-sm font-semibold">
                                <i class="fas fa-battery-full text-green-400"></i>
                                <span>Carga</span>
                            </div>
                            <div class="text-gray-200 text-sm">${extintor.carga}</div>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2 mb-1 text-gray-400 text-sm font-semibold">
                                <i class="fas ${extintor.lacrado === 'Sim' ? 'fa-lock text-green-400' : 'fa-unlock text-red-400'}"></i>
                                <span>Lacre</span>
                            </div>
                            <div class="text-sm font-medium ${extintor.lacrado === 'Sim' ? 'text-green-300' : 'text-red-300'}">${extintor.lacrado}</div>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg border border-purple-500/30 bg-purple-900/10">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-calendar-alt text-purple-400"></i>
                            <span class="text-purple-300 font-semibold text-sm">Manuten√ß√µes</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-gray-300 text-sm">
                            <div>
                                <div class="text-xs text-gray-400">√öltima</div>
                                ${new Date(extintor.ultimaManutencao).toLocaleDateString('pt-BR')}
                            </div>
                            <div>
                                <div class="text-xs text-gray-400">Pr√≥xima</div>
                                ${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                    </div>

                    ${extintor.observacao ? `
                        <div class="p-3 rounded-lg border-l-4 border-orange-400 bg-orange-900/10">
                            <div class="flex items-center space-x-2 text-orange-400 mb-1">
                                <i class="fas fa-comment"></i>
                                <span class="text-sm font-semibold">Observa√ß√£o</span>
                            </div>
                            <div class="text-sm text-gray-300 leading-relaxed">${extintor.observacao}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="action-buttons space-y-3">
                    <button onclick="toggleManutencao('${extintor.id}')"
                            class="${extintor.emManutencao === 'true' ? 'btn-maintenance-active' : 'btn-maintenance'} w-full py-2 rounded-lg font-semibold flex items-center justify-center space-x-2 transition-all">
                        <i class="fas ${extintor.emManutencao === 'true' ? 'fa-tools' : 'fa-wrench'}"></i>
                        <span>${extintor.emManutencao === 'true' ? 'Em Manuten√ß√£o' : 'Marcar Manuten√ß√£o'}</span>
                    </button>

                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="openHistoricoModal('${extintor.id}')" class="btn-purple text-xs py-2 rounded-lg font-semibold flex items-center justify-center space-x-1"><i class="fas fa-history"></i></button>
                        <button onclick="downloadQRCode('${extintor.id}')" class="btn-success text-xs py-2 rounded-lg font-semibold flex items-center justify-center space-x-1"><i class="fas fa-qrcode"></i></button>
                        <button onclick="openModal('${extintor.id}')" class="btn-info text-xs py-2 rounded-lg font-semibold flex items-center justify-center space-x-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteExtintor('${extintor.id}')" class="btn-primary text-xs py-2 rounded-lg font-semibold flex items-center justify-center space-x-1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    `;
                }).join('');


                // Gerar QR codes para cada extintor ap√≥s renderizar
                setTimeout(() => {
                    filteredExtintores.forEach(extintor => {
                        generateQRCodeForCard(extintor.id);
                    });
                }, 100);
            }
        }

        // Fun√ß√£o para gerar QR code no card
        async function generateQRCodeForCard(extintorId) {
            try {
                const container = document.getElementById(`qr-${extintorId}`);
                if (!container) return;

                const extintor = extintores.find(e => e.id === extintorId);
                if (!extintor) return;

                // QR Code cont√©m URL completa para redirecionamento
                const currentUrl = window.location.href.split('?')[0]; // Remove par√¢metros existentes
                const qrData = `${currentUrl}?extintor=${extintorId}`;

                // Tentar usar QRCode.js primeiro
                if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, qrData, {
                        width: 60,
                        height: 60,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'M'
                    });

                    container.innerHTML = '';
                    container.appendChild(canvas);
                } else {
                    // Fallback: usar API externa
                    try {
                        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=${encodeURIComponent(qrData)}`;

                        const img = new Image();
                        img.crossOrigin = 'anonymous';

                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = 60;
                            canvas.height = 60;

                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, 60, 60);
                            ctx.drawImage(img, 0, 0, 60, 60);

                            container.innerHTML = '';
                            container.appendChild(canvas);
                        };

                        img.onerror = function () {
                            // Fallback final: QR Code simples
                            createSimpleCardQR(container, extintor);
                        };

                        img.src = qrUrl;
                    } catch (error) {
                        createSimpleCardQR(container, extintor);
                    }
                }

                // Tooltip simples
                container.title = `QR Code Extintor #${extintor.numero}`;

            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
                const container = document.getElementById(`qr-${extintorId}`);
                if (container) {
                    const extintor = extintores.find(e => e.id === extintorId);
                    createSimpleCardQR(container, extintor);
                }
            }
        }

        function createSimpleCardQR(container, extintor) {
            container.innerHTML = `
                <div style="width: 100%; height: 100%; background: white; border: 2px solid #333; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 7px; text-align: center; color: #333; font-weight: bold;">
                    <div style="font-size: 8px;">üì±</div>
                    <div>#${extintor?.numero || '?'}</div>
                    <div style="font-size: 6px;">QR</div>
                </div>
            `;
        }



        function getFilteredExtintores() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tipoFilter = document.getElementById('filterTipo').value;
            const statusFilter = document.getElementById('filterStatus').value;

            return extintores.filter(extintor => {
                const matchSearch = !search ||
                    extintor.numero.toLowerCase().includes(search) ||
                    extintor.localizacao.toLowerCase().includes(search) ||
                    extintor.tipo.toLowerCase().includes(search);

                const matchTipo = !tipoFilter || extintor.tipo === tipoFilter;

                const status = getStatus(extintor.proximaManutencao);
                const matchStatus = !statusFilter || status === statusFilter;

                return matchSearch && matchTipo && matchStatus;
            });
        }

        function filterExtintores() {
            loadExtintores();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterStatus').value = '';
            loadExtintores();
        }

        function updateDashboard() {
            const total = extintores.length;
            let vencidos = 0, proximos = 0, emDia = 0;

            extintores.forEach(extintor => {
                const status = getStatus(extintor.proximaManutencao);
                switch (status) {
                    case 'vencido': vencidos++; break;
                    case 'proximo': proximos++; break;
                    case 'ok': emDia++; break;
                }
            });

            document.getElementById('totalExtintores').textContent = total;
            document.getElementById('totalVencidos').textContent = vencidos;
            document.getElementById('totalProximos').textContent = proximos;
            document.getElementById('totalEmDia').textContent = emDia;
        }

        // Fun√ß√µes do Scanner QR
        function openScannerModal() {
            const modal = document.getElementById('scannerModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Verificar se a biblioteca est√° carregada
            if (typeof Html5QrcodeScanner === 'undefined') {
                document.getElementById('qr-reader').innerHTML = `
                    <div class="bg-red-900 bg-opacity-30 border border-red-500 p-4 rounded-lg text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                        <p class="text-red-300">Scanner n√£o dispon√≠vel</p>
                        <p class="text-red-400 text-sm">Biblioteca n√£o carregada</p>
                    </div>
                `;
                return;
            }

            // Inicializar scanner
            try {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader",
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        rememberLastUsedCamera: true,
                        showTorchButtonIfSupported: true
                    },
                    false
                );

                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            } catch (error) {
                console.error('Erro ao inicializar scanner:', error);
                document.getElementById('qr-reader').innerHTML = `
                    <div class="bg-red-900 bg-opacity-30 border border-red-500 p-4 rounded-lg text-center">
                        <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                        <p class="text-red-300">Erro ao inicializar scanner</p>
                        <p class="text-red-400 text-sm">Verifique as permiss√µes da c√¢mera</p>
                    </div>
                `;
            }
        }

        function closeScannerModal() {
            const modal = document.getElementById('scannerModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            if (html5QrcodeScanner) {
                try {
                    html5QrcodeScanner.clear();
                } catch (error) {
                    console.log('Scanner j√° limpo');
                }
                html5QrcodeScanner = null;
            }

            // Reset completo
            document.getElementById('scanResult').classList.add('hidden');
            scannedExtintorId = null;
            scanProcessing = false; // Reset da flag

            // Limpar conte√∫do do scanner
            document.getElementById('qr-reader').innerHTML = '';
        }

        let scanProcessing = false; // Flag para evitar m√∫ltiplas detec√ß√µes
        function onScanSuccess(decodedText, decodedResult) {
            // Evitar processamento m√∫ltiplo
            if (scanProcessing) return;
            scanProcessing = true;

            // Parar o scanner imediatamente
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }

            // Normaliza o texto escaneado (remove espa√ßos, s√≠mbolos e acentos)
            let textoLimpo = decodedText
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove acentos
                .replace(/\s+/g, '')                              // remove espa√ßos
                .replace(/[^a-zA-Z0-9]/g, '')                     // remove s√≠mbolos
                .toLowerCase();

            // Fun√ß√£o de similaridade (para toler√¢ncia de leitura parcial)
            const similaridade = (a, b) => {
                if (!a || !b) return 0;
                a = a.toLowerCase();
                b = b.toLowerCase();
                let iguais = 0;
                for (let i = 0; i < Math.min(a.length, b.length); i++) {
                    if (a[i] === b[i]) iguais++;
                }
                return iguais / Math.max(a.length, b.length);
            };

            // Buscar extintor pelo ID exato
            let extintor = extintores.find(e => e.id === decodedText);

            // Se n√£o encontrou, buscar pelo n√∫mero exato
            if (!extintor) {
                extintor = extintores.find(e => e.numero === decodedText);
            }

            // Se ainda n√£o encontrou, tentar pelo n√∫mero extra√≠do
            if (!extintor) {
                const numeroMatch = decodedText.match(/\d+/);
                if (numeroMatch) {
                    extintor = extintores.find(e => e.numero === numeroMatch[0]);
                }
            }

            // Se mesmo assim n√£o achou, procurar por similaridade
            if (!extintor) {
                let melhorMatch = null;
                let melhorScore = 0;

                for (const e of extintores) {
                    const idScore = similaridade(textoLimpo, e.id?.toLowerCase() || '');
                    const numScore = similaridade(textoLimpo, (e.numero || '').toString());
                    const score = Math.max(idScore, numScore);

                    if (score > melhorScore) {
                        melhorScore = score;
                        melhorMatch = e;
                    }
                }

                // Considera encontrado se tiver pelo menos 50% de semelhan√ßa
                if (melhorMatch && melhorScore >= 0.5) {
                    extintor = melhorMatch;
                }
            }

            // Resultado final
            if (extintor) {
                // Fechar modal do scanner
                closeScannerModal();

                // Pequeno delay para garantir que o modal anterior fechou
                setTimeout(() => {
                    showExtintorModal(extintor);
                }, 300);
            } else {
                // Extintor n√£o encontrado
                document.getElementById('scanResult').classList.remove('hidden');
                document.getElementById('scanResultContent').innerHTML = `
            <div class="bg-red-900 bg-opacity-30 border border-red-500 p-4 rounded-lg">
                <h4 class="text-red-400 font-bold mb-2">‚ö†Ô∏è Extintor n√£o encontrado</h4>
                <p class="text-red-300 text-sm mb-2">
                    QR Code lido: <code class="bg-black bg-opacity-30 px-2 py-1 rounded">${decodedText}</code>
                </p>
                <p class="text-red-400 text-xs">
                    O c√≥digo parece danificado ou plastificado. Tente ajustar o √¢ngulo da c√¢mera ou se aproximar um pouco mais.
                </p>
            </div>
        `;
            }

            // Reset da flag ap√≥s breve delay
            setTimeout(() => {
                scanProcessing = false;
            }, 800);
        }


        function onScanFailure(error) {
            // Ignorar erros de scan (muito verboso)
        }

        function showExtintorModal(extintor) {
            const modal = document.getElementById('extintorInfoModal');
            const content = document.getElementById('extintorInfoContent');

            const status = getStatus(extintor.proximaManutencao);
            const statusText = getStatusText(status);
            const diasRestantes = getDiasRestantes(extintor.proximaManutencao);

            let statusBadge = '';
            let statusClass = '';

            if (status === 'vencido') {
                statusBadge = 'bg-red-100 text-red-800';
                statusClass = 'border-red-500 bg-red-900 bg-opacity-20';
            } else if (status === 'proximo') {
                statusBadge = 'bg-yellow-100 text-yellow-800';
                statusClass = 'border-yellow-500 bg-yellow-900 bg-opacity-20';
            } else {
                statusBadge = 'bg-green-100 text-green-800';
                statusClass = 'border-green-500 bg-green-900 bg-opacity-20';
            }

            content.innerHTML = `
                <div class="space-y-4">
                    <!-- Status Principal -->
                    <div class="${statusClass} border-l-4 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-bold text-white">Extintor #${extintor.numero}</h3>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${statusBadge}">
                                ${statusText.toUpperCase()}
                            </span>
                        </div>
                        <p class="text-gray-300">${extintor.localizacao}</p>
                        ${status === 'vencido' ?
                    '<p class="text-red-300 text-sm font-semibold mt-2">‚ö†Ô∏è Manuten√ß√£o vencida - A√ß√£o necess√°ria</p>' :
                    status === 'proximo' ?
                        `<p class="text-yellow-300 text-sm font-semibold mt-2">üîî Vence em ${diasRestantes} dias</p>` :
                        '<p class="text-green-300 text-sm font-semibold mt-2">‚úÖ Situa√ß√£o regular</p>'
                }
                    </div>
                    
                    <!-- Informa√ß√µes T√©cnicas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 bg-opacity-50 p-3 rounded-lg">
                            <div class="text-gray-400 text-xs mb-1">Tipo</div>
                            <div class="text-white font-semibold">${extintor.tipo}</div>
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 p-3 rounded-lg">
                            <div class="text-gray-400 text-xs mb-1">Peso</div>
                            <div class="text-white font-semibold">${extintor.kg}kg</div>
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 p-3 rounded-lg">
                            <div class="text-gray-400 text-xs mb-1">Carga</div>
                            <div class="text-white font-semibold">${extintor.carga}</div>
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 p-3 rounded-lg">
                            <div class="text-gray-400 text-xs mb-1">Lacre</div>
                            <div class="text-white font-semibold ${extintor.lacrado === 'Sim' ? 'text-green-300' : 'text-red-300'}">
                                <i class="fas ${extintor.lacrado === 'Sim' ? 'fa-lock' : 'fa-unlock'} mr-1"></i>
                                ${extintor.lacrado}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Datas de Manuten√ß√£o -->
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg">
                        <h4 class="text-white font-semibold mb-3 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-blue-400"></i>
                            Manuten√ß√µes
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-gray-400 text-xs mb-1">√öltima Manuten√ß√£o</div>
                                <div class="text-white font-semibold">${new Date(extintor.ultimaManutencao).toLocaleDateString('pt-BR')}</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-xs mb-1">Pr√≥xima Manuten√ß√£o</div>
                                <div class="text-white font-semibold">${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}</div>
                            </div>
                        </div>
                    </div>
                    
                    ${extintor.observacao ? `
                    <div class="bg-orange-900 bg-opacity-30 border border-orange-500 p-4 rounded-lg">
                        <h4 class="text-orange-300 font-semibold mb-2 flex items-center">
                            <i class="fas fa-comment mr-2"></i>
                            Observa√ß√£o
                        </h4>
                        <p class="text-orange-100 text-sm">${extintor.observacao}</p>
                    </div>
                    ` : ''}
                    
                    ${extintor.responsavel ? `
                    <div class="bg-purple-900 bg-opacity-30 border border-purple-500 p-3 rounded-lg">
                        <div class="text-purple-300 text-xs mb-1">Respons√°vel pela Manuten√ß√£o</div>
                        <div class="text-purple-100 font-semibold">${extintor.responsavel}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Configurar bot√£o de edi√ß√£o
            document.getElementById('editExtintorFromModal').onclick = function () {
                closeExtintorInfoModal();
                setTimeout(() => {
                    openModal(extintor.id);
                }, 300);
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeExtintorInfoModal() {
            document.getElementById('extintorInfoModal').classList.add('hidden');
            document.getElementById('extintorInfoModal').classList.remove('flex');
        }

        function resetScanner() {
            document.getElementById('scanResult').classList.add('hidden');
            scannedExtintorId = null;
            scanProcessing = false;
            openScannerModal();
        }

        function editScannedExtintor() {
            if (scannedExtintorId) {
                closeScannerModal();
                setTimeout(() => {
                    openModal(scannedExtintorId);
                }, 300);
            }
        }

        // Fun√ß√£o para alternar status de manuten√ß√£o
        async function toggleManutencao(id) {
            try {
                const extintor = extintores.find(e => e.id === id);
                if (!extintor) return;

                const agora = new Date().toISOString().split('T')[0];
                const proximoAno = new Date();
                proximoAno.setFullYear(proximoAno.getFullYear() + 1);
                const proximaManutencao = proximoAno.toISOString().split('T')[0];
                const agoraHora = new Date().toLocaleString('pt-BR');

                if (extintor.emManutencao === 'true') {
                    // Sair do modo manuten√ß√£o - manuten√ß√£o foi conclu√≠da
                    extintor.emManutencao = 'false';
                    extintor.ultimaManutencao = agora;
                    extintor.proximaManutencao = proximaManutencao;
                    extintor.observacao = 'Manuten√ß√£o conclu√≠da';

                    // Atualizar no Firebase
                    await updateExtintorInFirebase(id, {
                        emManutencao: 'false',
                        ultimaManutencao: agora,
                        proximaManutencao: proximaManutencao,
                        observacao: 'Manuten√ß√£o conclu√≠da'
                    });

                    // Adicionar ao hist√≥rico
                    await addHistoricoEntry(id, {
                        data: agora,
                        hora: agoraHora,
                        tipo: 'manutencao',
                        responsavel: 'T√©cnico de Manuten√ß√£o',
                        observacao: 'Manuten√ß√£o preventiva conclu√≠da com sucesso',
                        detalhes: {
                            ultimaManutencao: agora,
                            proximaManutencao: proximaManutencao,
                            status: 'Em dia'
                        }
                    });

                    // Mostrar notifica√ß√£o de sucesso
                    showNotification('‚úÖ Manuten√ß√£o Conclu√≠da!', `Extintor #${extintor.numero} - Pr√≥xima manuten√ß√£o: ${new Date(proximaManutencao).toLocaleDateString('pt-BR')}`, 'success');

                } else {
                    // Entrar no modo manuten√ß√£o
                    extintor.emManutencao = 'true';

                    // Atualizar no Firebase
                    await updateExtintorInFirebase(id, {
                        emManutencao: 'true'
                    });

                    // Adicionar ao hist√≥rico
                    await addHistoricoEntry(id, {
                        data: agora,
                        hora: agoraHora,
                        tipo: 'edicao',
                        responsavel: 'Sistema',
                        observacao: 'Extintor marcado para manuten√ß√£o',
                        detalhes: {
                            ultimaManutencao: extintor.ultimaManutencao,
                            proximaManutencao: extintor.proximaManutencao,
                            status: 'Em Manuten√ß√£o'
                        }
                    });

                    // Mostrar notifica√ß√£o
                    showNotification('üîß Modo Manuten√ß√£o', `Extintor #${extintor.numero} marcado para manuten√ß√£o`, 'info');
                }

                loadExtintores();
                updateDashboard();
                checkProximasManutencoes();
            } catch (error) {
                console.error('Erro ao alterar status de manuten√ß√£o:', error);
                showNotification('‚ùå Erro', 'N√£o foi poss√≠vel alterar o status de manuten√ß√£o', 'error');
            }
        }

        // Sistema de Notifica√ß√µes
        function showNotification(title, message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notificationId = 'notification_' + Date.now();

            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `notification ${type}`;
            notification.style.position = 'relative';

            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${title}</div>
                    <button class="notification-close" onclick="closeNotification('${notificationId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-message">${message}</div>
                <div class="notification-progress"></div>
            `;

            container.appendChild(notification);

            // Animar entrada
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Auto-remover ap√≥s dura√ß√£o especificada
            setTimeout(() => {
                closeNotification(notificationId);
            }, duration);
        }

        function closeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }
        }

        // Verificar pr√≥ximas manuten√ß√µes e alertas
        function checkProximasManutencoes() {
            const hoje = new Date();
            let vencidos = [];
            let proximos = [];

            extintores.forEach(extintor => {
                if (extintor.emManutencao === 'true') return; // Ignorar extintores em manuten√ß√£o

                const proximaData = new Date(extintor.proximaManutencao);
                const diffTime = proximaData - hoje;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    vencidos.push(extintor);
                } else if (diffDays <= 30) {
                    proximos.push(extintor);
                }
            });

            // Mostrar banner de alerta se houver extintores vencidos
            const alertBanner = document.getElementById('alertBanner');
            const alertMessage = document.getElementById('alertMessage');

            if (vencidos.length > 0) {
                alertBanner.className = 'alert-banner';
                alertMessage.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>ATEN√á√ÉO!</strong> ${vencidos.length} extintor${vencidos.length > 1 ? 'es' : ''} com manuten√ß√£o vencida!
                    <button onclick="showVencidosModal()" class="ml-4 bg-white bg-opacity-20 px-3 py-1 rounded text-sm hover:bg-opacity-30 transition-all">
                        Ver Detalhes
                    </button>
                `;
                alertBanner.classList.remove('hidden');
            } else if (proximos.length > 0) {
                alertBanner.className = 'alert-banner warning';
                alertMessage.innerHTML = `
                    <i class="fas fa-clock mr-2"></i>
                    <strong>AVISO:</strong> ${proximos.length} extintor${proximos.length > 1 ? 'es' : ''} com manuten√ß√£o pr√≥xima (30 dias)
                    <button onclick="showProximosModal()" class="ml-4 bg-white bg-opacity-20 px-3 py-1 rounded text-sm hover:bg-opacity-30 transition-all">
                        Ver Detalhes
                    </button>
                `;
                alertBanner.classList.remove('hidden');
            } else {
                alertBanner.classList.add('hidden');
            }

            // Salvar alertas no localStorage para persist√™ncia
            localStorage.setItem('alertas', JSON.stringify({
                vencidos: vencidos.map(e => e.id),
                proximos: proximos.map(e => e.id),
                lastCheck: hoje.toISOString()
            }));
        }

        // Mostrar modal com extintores vencidos
        function showVencidosModal() {
            const vencidos = extintores.filter(extintor => {
                if (extintor.emManutencao === 'true') return false;
                const diffDays = getDiasRestantes(extintor.proximaManutencao);
                return diffDays < 0;
            });

            showAlertModal('Extintores com Manuten√ß√£o Vencida', vencidos, 'error');
        }

        // Mostrar modal com extintores pr√≥ximos
        function showProximosModal() {
            const proximos = extintores.filter(extintor => {
                if (extintor.emManutencao === 'true') return false;
                const diffDays = getDiasRestantes(extintor.proximaManutencao);
                return diffDays >= 0 && diffDays <= 30;
            });

            showAlertModal('Extintores com Manuten√ß√£o Pr√≥xima', proximos, 'warning');
        }

        // Modal gen√©rico para alertas
        function showAlertModal(title, extintores, type) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4';
            modal.id = 'alertModal';

            const typeColors = {
                error: { bg: 'bg-red-900', border: 'border-red-500', text: 'text-red-300', icon: 'fa-exclamation-triangle' },
                warning: { bg: 'bg-yellow-900', border: 'border-yellow-500', text: 'text-yellow-300', icon: 'fa-clock' }
            };

            const colors = typeColors[type] || typeColors.warning;

            modal.innerHTML = `
                <div class="card-gradient p-6 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white flex items-center">
                            <i class="fas ${colors.icon} mr-2 ${colors.text}"></i>
                            ${title}
                        </h2>
                        <button onclick="closeAlertModal()" class="text-gray-400 hover:text-white text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${extintores.map(extintor => {
                const diasRestantes = getDiasRestantes(extintor.proximaManutencao);
                const statusText = diasRestantes < 0 ?
                    `Vencido h√° ${Math.abs(diasRestantes)} dias` :
                    `Vence em ${diasRestantes} dias`;

                return `
                                <div class="${colors.bg} bg-opacity-30 border ${colors.border} p-4 rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-white font-bold">Extintor #${extintor.numero}</h3>
                                        <span class="text-xs ${colors.text} font-bold">${statusText}</span>
                                    </div>
                                    <p class="text-gray-300 text-sm mb-2">${extintor.localizacao}</p>
                                    <div class="text-xs text-gray-400">
                                        Pr√≥xima manuten√ß√£o: ${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}
                                    </div>
                                    <div class="mt-3 flex space-x-2">
                                        <button onclick="toggleManutencao('${extintor.id}'); closeAlertModal();" 
                                                class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs font-semibold transition-all">
                                            <i class="fas fa-wrench mr-1"></i>Marcar Manuten√ß√£o
                                        </button>
                                        <button onclick="openModal('${extintor.id}'); closeAlertModal();" 
                                                class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-xs font-semibold transition-all">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </button>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeAlertModal()" 
                                class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-all">
                            Fechar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeAlertModal() {
            const modal = document.getElementById('alertModal');
            if (modal) {
                modal.remove();
            }
        }

        // Fun√ß√µes de QR Code e Relat√≥rio
        async function downloadQRCode(extintorId) {
            try {
                const extintor = extintores.find(e => e.id === extintorId);
                if (!extintor) return;

                // Dados do QR Code (URL completa para redirecionamento)
                const currentUrl = window.location.href.split('?')[0];
                const qrData = `${currentUrl}?extintor=${extintorId}`;

                // Tentar usar QRCode.js
                if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, qrData, {
                        width: 300,
                        height: 300,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'M'
                    });

                    // Criar canvas com informa√ß√µes do extintor
                    const finalCanvas = document.createElement('canvas');
                    const ctx = finalCanvas.getContext('2d');
                    finalCanvas.width = 400;
                    finalCanvas.height = 450;

                    // Fundo branco
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, 400, 450);

                    // Desenhar QR Code
                    ctx.drawImage(canvas, 50, 50, 300, 300);

                    // Adicionar informa√ß√µes do extintor
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Extintor #${extintor.numero}`, 200, 380);

                    ctx.font = '16px Arial';
                    ctx.fillText(extintor.localizacao, 200, 405);

                    ctx.font = '14px Arial';
                    ctx.fillText(`${extintor.tipo} ‚Ä¢ ${extintor.kg}kg`, 200, 425);

                    // Download
                    const link = document.createElement('a');
                    link.download = `extintor_${extintor.numero}_qr.png`;
                    link.href = finalCanvas.toDataURL();
                    link.click();
                } else {
                    // Fallback: usar API externa
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;

                    const img = new Image();
                    img.crossOrigin = 'anonymous';

                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 400;
                        canvas.height = 450;

                        // Fundo branco
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, 400, 450);

                        // Desenhar QR Code
                        ctx.drawImage(img, 50, 50, 300, 300);

                        // Adicionar informa√ß√µes
                        ctx.fillStyle = '#000000';
                        ctx.font = 'bold 24px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`Extintor #${extintor.numero}`, 200, 380);

                        ctx.font = '16px Arial';
                        ctx.fillText(extintor.localizacao, 200, 405);

                        ctx.font = '14px Arial';
                        ctx.fillText(`${extintor.tipo} ‚Ä¢ ${extintor.kg}kg`, 200, 425);

                        // Download
                        const link = document.createElement('a');
                        link.download = `extintor_${extintor.numero}_qr.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    };

                    img.onerror = function () {
                        alert('Erro ao gerar QR Code. Tente novamente.');
                    };

                    img.src = qrUrl;
                }
            } catch (error) {
                console.error('Erro ao baixar QR Code:', error);
                alert('Erro ao gerar QR Code. Tente novamente.');
            }
        }

        async function generateAllQRCodes() {
            if (extintores.length === 0) {
                alert('Nenhum extintor cadastrado para gerar QR Codes.');
                return;
            }

            try {
                // Usar JSZip para criar arquivo ZIP
                if (typeof JSZip === 'undefined') {
                    alert('Biblioteca JSZip n√£o carregada. Baixando QR Codes individualmente...');

                    // Fallback: baixar um por vez
                    for (let i = 0; i < extintores.length; i++) {
                        await new Promise(resolve => {
                            setTimeout(() => {
                                downloadQRCode(extintores[i].id);
                                resolve();
                            }, 500 * i); // Delay entre downloads
                        });
                    }
                    return;
                }

                const zip = new JSZip();
                const qrFolder = zip.folder("qr_codes_extintores");

                // Gerar QR Code para cada extintor
                for (const extintor of extintores) {
                    try {
                        const currentUrl = window.location.href.split('?')[0];
                        const qrData = `${currentUrl}?extintor=${extintor.id}`;

                        if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
                            const canvas = document.createElement('canvas');
                            await QRCode.toCanvas(canvas, qrData, {
                                width: 300,
                                height: 300,
                                margin: 2,
                                color: {
                                    dark: '#000000',
                                    light: '#FFFFFF'
                                },
                                errorCorrectionLevel: 'M'
                            });

                            // Criar canvas final com informa√ß√µes
                            const finalCanvas = document.createElement('canvas');
                            const ctx = finalCanvas.getContext('2d');
                            finalCanvas.width = 400;
                            finalCanvas.height = 450;

                            // Fundo branco
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, 400, 450);

                            // Desenhar QR Code
                            ctx.drawImage(canvas, 50, 50, 300, 300);

                            // Adicionar informa√ß√µes
                            ctx.fillStyle = '#000000';
                            ctx.font = 'bold 24px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(`Extintor #${extintor.numero}`, 200, 380);

                            ctx.font = '16px Arial';
                            ctx.fillText(extintor.localizacao, 200, 405);

                            ctx.font = '14px Arial';
                            ctx.fillText(`${extintor.tipo} ‚Ä¢ ${extintor.kg}kg`, 200, 425);

                            // Converter para blob e adicionar ao ZIP
                            const dataUrl = finalCanvas.toDataURL('image/png');
                            const base64Data = dataUrl.split(',')[1];

                            qrFolder.file(`extintor_${extintor.numero.padStart(3, '0')}_qr.png`, base64Data, { base64: true });
                        }
                    } catch (error) {
                        console.error(`Erro ao gerar QR para extintor ${extintor.numero}:`, error);
                    }
                }

                // Gerar e baixar ZIP
                const content = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `qr_codes_extintores_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();

                // Limpar URL
                setTimeout(() => {
                    URL.revokeObjectURL(link.href);
                }, 1000);

            } catch (error) {
                console.error('Erro ao gerar ZIP:', error);
                alert('Erro ao gerar arquivo ZIP. Tente baixar os QR Codes individualmente.');
            }
        }


        async function generateReport() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    alert('Biblioteca jsPDF n√£o carregada. Tente recarregar a p√°gina.');
                    return;
                }

                const agora = new Date();
                document.getElementById('reportDate').textContent = agora.toLocaleString('pt-BR');

                // === Agrupamento dos extintores ===
                const statusGroups = { ok: [], proximo: [], vencido: [] };
                extintores.forEach(ext => statusGroups[getStatus(ext.proximaManutencao)].push(ext));

                const totalExtintores = extintores.length;
                const percentual = (n) => totalExtintores > 0 ? Math.round((n / totalExtintores) * 100) : 0;
                const percentualOk = percentual(statusGroups.ok.length);
                const percentualProximo = percentual(statusGroups.proximo.length);
                const percentualVencido = percentual(statusGroups.vencido.length);

                // === Utilidades ===
                const chunkArray = (array, size) =>
                    Array.from({ length: Math.ceil(array.length / size) }, (_, i) => array.slice(i * size, i * size + size));

                // === CARD DE EXTINTOR ===
                const createCardHTML = (extintor) => {
                    const status = getStatus(extintor.proximaManutencao);
                    const diasRestantes = getDiasRestantes(extintor.proximaManutencao);
                    const cores = {
                        vencido: { c: '#c0392b', bg: '#fdeaea', icon: 'fas fa-exclamation-circle', txt: 'VENCIDO' },
                        proximo: { c: '#d68910', bg: '#fff7e0', icon: 'fas fa-clock', txt: `Vence em ${diasRestantes} dias` },
                        ok: { c: '#1e8449', bg: '#e9f7ef', icon: 'fas fa-shield-alt', txt: 'Em Conformidade' }
                    }[status];

                    return `
                <div style="background:#fff; border:1px solid #e1e8ed; border-radius:10px; padding:20px; height:185px;
                            box-shadow:0 2px 5px rgba(0,0,0,0.07); display:flex; flex-direction:column; justify-content:space-between;
                            position:relative; overflow:hidden;">
                    <div style="position:absolute; top:0; left:0; width:5px; height:100%; background:${cores.c};"></div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h4 style="margin:0 0 6px 0; font-size:17px; font-weight:700; color:#2c3e50;">
                                <i class="${cores.icon}" style="margin-right:8px; color:${cores.c}; font-size:15px;"></i>
                                Extintor #${extintor.numero}
                            </h4>
                            <p style="font-size:13px; color:#7f8c8d; margin:0;">
                                <i class="fas fa-map-marker-alt" style="color:#95a5a6; margin-right:5px;"></i>${extintor.localizacao}
                            </p>
                        </div>
                        <span style="font-size:11px; font-weight:700; color:${cores.c}; background:${cores.bg}; padding:6px 10px; border-radius:12px; white-space:nowrap; border:1px solid ${cores.c}22;">
                            ${cores.txt}
                        </span>
                    </div>

                    <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:8px; margin-top:12px; font-size:13px; color:#34495e;">
                        <div style="background:#f9fafb; padding:8px; border-radius:6px; display:flex; align-items:center;">
                            <i class="fas fa-tag" style="margin-right:6px; font-size:11px; color:#6c757d;"></i>
                            <strong>Tipo:</strong>&nbsp;${extintor.tipo}
                        </div>
                        <div style="background:#f9fafb; padding:8px; border-radius:6px; display:flex; align-items:center;">
                            <i class="fas fa-weight-hanging" style="margin-right:6px; font-size:11px; color:#6c757d;"></i>
                            <strong>Peso:</strong>&nbsp;${extintor.kg}kg
                        </div>
                        <div style="background:#f9fafb; padding:8px; border-radius:6px; display:flex; align-items:center;">
                            <i class="fas fa-lock" style="margin-right:6px; font-size:11px; color:#6c757d;"></i>
                            <strong>Lacre:</strong>&nbsp;${extintor.lacrado === 'Sim' ? 'OK' : 'Aberto'}
                        </div>
                        <div style="background:#f9fafb; padding:8px; border-radius:6px; display:flex; align-items:center;">
                            <i class="fas fa-calendar-alt" style="margin-right:6px; font-size:11px; color:#6c757d;"></i>
                            <strong>Pr√≥x.:</strong>&nbsp;${new Date(extintor.proximaManutencao).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                </div>`;
                };

                // === PRIMEIRA P√ÅGINA (RESUMO COMPLETO) ===


                const createFirstPageHTML = () => `
    <div style="width:210mm; height:297mm; background:#f8f9fa; display:flex; flex-direction:column;">


            <div style="flex:1; text-align:center;">
                <h1 style="margin:0; font-size:28px; font-weight:700; text-align:center;">
                    <i class="fas fa-shield-alt" style="margin-right:10px; color:#27ae60;"></i>
                    Relat√≥rio de Seguran√ßa - Extintores
                </h1>
                <p style="margin:10px 0 0 0; font-size:15px; opacity:0.9; text-align:center;">
                    Gerado em ${agora.toLocaleString('pt-BR')}
                </p>
                <div style="background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:15px; 
                            display:inline-block; margin-top:8px; font-size:12px; font-weight:600; text-align:center;">
                    EMBALAGENS TATU√ç
                </div>
            </div>

            <div style="text-align:center; color:rgba(255,255,255,0.9);">
                <div style="font-size:24px; font-weight:700; margin-bottom:4px; text-align:center;">${totalExtintores}</div>
                <div style="font-size:11px; text-transform:uppercase; letter-spacing:1px; text-align:center;">Total</div>
            </div>
        </div>

        <!-- INDICADORES -->
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:18px; margin:25px 15mm;">
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                        border:1px solid #e1e8ed; border-radius:12px; padding:20px; text-align:center;
                        box-shadow:0 4px 12px rgba(0,0,0,0.08); position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; left:0; width:100%; height:4px; 
                            background:linear-gradient(90deg, #2c3e50, #34495e);"></div>
                <div style="background:#f8f9fa; width:50px; height:50px; border-radius:50%; 
                            display:flex; align-items:center; justify-content:center; margin:0 auto 12px auto;">
                    <i class="fas fa-fire-extinguisher" style="font-size:20px; color:#2c3e50;"></i>
                </div>
                <div style="font-size:34px; font-weight:800; color:#2c3e50; margin-bottom:6px; text-align:center;">${totalExtintores}</div>
                <p style="font-size:13px; color:#7f8c8d; font-weight:600; margin:0; text-align:center;">Total de Extintores</p>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff 0%, #f0f9f4 100%); 
                        border:1px solid #e1e8ed; border-radius:12px; padding:20px; text-align:center;
                        box-shadow:0 4px 12px rgba(0,0,0,0.08); position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; left:0; width:100%; height:4px; 
                            background:linear-gradient(90deg, #1e8449, #27ae60);"></div>
                <div style="background:#e8f5e8; width:50px; height:50px; border-radius:50%; 
                            display:flex; align-items:center; justify-content:center; margin:0 auto 12px auto;">
                    <i class="fas fa-shield-alt" style="font-size:20px; color:#1e8449;"></i>
                </div>
                <div style="font-size:34px; font-weight:800; color:#1e8449; margin-bottom:6px; text-align:center;">${statusGroups.ok.length}</div>
                <p style="font-size:13px; color:#1e8449; font-weight:600; margin:0; text-align:center;">Conformes (${percentualOk}%)</p>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff 0%, #fef9e7 100%); 
                        border:1px solid #e1e8ed; border-radius:12px; padding:20px; text-align:center;
                        box-shadow:0 4px 12px rgba(0,0,0,0.08); position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; left:0; width:100%; height:4px; 
                            background:linear-gradient(90deg, #d68910, #f39c12);"></div>
                <div style="background:#fef3cd; width:50px; height:50px; border-radius:50%; 
                            display:flex; align-items:center; justify-content:center; margin:0 auto 12px auto;">
                    <i class="fas fa-clock" style="font-size:20px; color:#d68910;"></i>
                </div>
                <div style="font-size:34px; font-weight:800; color:#d68910; margin-bottom:6px; text-align:center;">${statusGroups.proximo.length}</div>
                <p style="font-size:13px; color:#d68910; font-weight:600; margin:0; text-align:center;">Pr√≥x. Venc. (${percentualProximo}%)</p>
            </div>
            
            <div style="background:linear-gradient(135deg, #ffffff 0%, #fdf2f2 100%); 
                        border:1px solid #e1e8ed; border-radius:12px; padding:20px; text-align:center;
                        box-shadow:0 4px 12px rgba(0,0,0,0.08); position:relative; overflow:hidden;">
                <div style="position:absolute; top:0; left:0; width:100%; height:4px; 
                            background:linear-gradient(90deg, #c0392b, #e74c3c);"></div>
                <div style="background:#f8d7da; width:50px; height:50px; border-radius:50%; 
                            display:flex; align-items:center; justify-content:center; margin:0 auto 12px auto;">
                    <i class="fas fa-exclamation-triangle" style="font-size:20px; color:#c0392b;"></i>
                </div>
                <div style="font-size:34px; font-weight:800; color:#c0392b; margin-bottom:6px; text-align:center;">${statusGroups.vencido.length}</div>
                <p style="font-size:13px; color:#c0392b; font-weight:600; margin:0; text-align:center;">Vencidos (${percentualVencido}%)</p>
            </div>
        </div>

        <!-- GR√ÅFICO -->
        <div style="margin:10px 15mm 0 15mm; background:#fff; border:1px solid #e1e8ed; border-radius:12px; 
                    padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <h3 style="margin:0 0 20px 0; color:#2c3e50; font-size:18px; font-weight:700; text-align:center;">
                <i class="fas fa-chart-bar" style="margin-right:10px; color:#3498db;"></i>
                Distribui√ß√£o de Status
            </h3>
            <div style="display:flex; flex-direction:column; gap:18px;">
                ${[
                        { nome: 'Conformes', cor: '#1e8449', valor: percentualOk, icon: 'fas fa-shield-alt' },
                        { nome: 'Pr√≥x. Venc.', cor: '#d68910', valor: percentualProximo, icon: 'fas fa-clock' },
                        { nome: 'Vencidos', cor: '#c0392b', valor: percentualVencido, icon: 'fas fa-exclamation-triangle' }
                    ].map(c => `
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i class="${c.icon}" style="color:${c.cor}; font-size:16px; width:20px; text-align:center;"></i>
                        <span style="width:120px; font-weight:600; color:${c.cor}; text-align:left;">${c.nome}</span>
                        <div style="flex:1; height:24px; background:#f1f3f4; border-radius:12px; position:relative; overflow:hidden;">
                            <div style="width:${c.valor}%; height:100%; background:linear-gradient(90deg,${c.cor},${c.cor}dd); 
                                        border-radius:12px; display:flex; align-items:center; justify-content:center;
                                        color:white; font-size:11px; font-weight:600; text-align:center;">
                                ${c.valor > 15 ? c.valor + '%' : ''}
                            </div>
                        </div>
                        <span style="width:50px; text-align:center; font-weight:700; color:${c.cor};">${c.valor}%</span>
                    </div>`).join('')}
            </div>
        </div>

        <!-- ALERTAS DE SEGURAN√áA -->
        <div style="margin:15px 15mm 0 15mm; background:#fff; border:1px solid #e1e8ed; border-radius:12px; 
                    padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <h3 style="margin:0 0 18px 0; color:#2c3e50; font-size:18px; font-weight:700; text-align:center;">
                <i class="fas fa-exclamation-circle" style="margin-right:10px; color:#e74c3c;"></i>
                Alertas de Seguran√ßa
            </h3>
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px;">
                ${statusGroups.vencido.length > 0 ? `
                <div style="background:linear-gradient(135deg, #fdf2f2 0%, #ffffff 100%); 
                            border-left:4px solid #e74c3c; padding:15px; border-radius:8px; text-align:center;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:8px;">
                        <i class="fas fa-exclamation-triangle" style="color:#e74c3c; font-size:16px;"></i>
                        <span style="font-weight:700; color:#c0392b;">A√á√ÉO URGENTE</span>
                    </div>
                    <p style="margin:0; font-size:13px; color:#721c24; text-align:center;">
                        ${statusGroups.vencido.length} extintor${statusGroups.vencido.length > 1 ? 'es' : ''} 
                        vencido${statusGroups.vencido.length > 1 ? 's' : ''} - Substitui√ß√£o imediata necess√°ria
                    </p>
                </div>` : ''}
                
                ${statusGroups.proximo.length > 0 ? `
                <div style="background:linear-gradient(135deg, #fef9e7 0%, #ffffff 100%); 
                            border-left:4px solid #f39c12; padding:15px; border-radius:8px; text-align:center;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:8px;">
                        <i class="fas fa-clock" style="color:#f39c12; font-size:16px;"></i>
                        <span style="font-weight:700; color:#d68910;">ATEN√á√ÉO</span>
                    </div>
                    <p style="margin:0; font-size:13px; color:#7d6608; text-align:center;">
                        ${statusGroups.proximo.length} extintor${statusGroups.proximo.length > 1 ? 'es' : ''} 
                        pr√≥ximo${statusGroups.proximo.length > 1 ? 's' : ''} do vencimento - Agendar manuten√ß√£o
                    </p>
                </div>` : ''}
                
                ${statusGroups.ok.length === totalExtintores && totalExtintores > 0 ? `
                <div style="background:linear-gradient(135deg, #f0f9f4 0%, #ffffff 100%); 
                            border-left:4px solid #27ae60; padding:15px; border-radius:8px; grid-column:1/-1; text-align:center;">
                    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:8px;">
                        <i class="fas fa-check-circle" style="color:#27ae60; font-size:16px;"></i>
                        <span style="font-weight:700; color:#1e8449;">SISTEMA EM CONFORMIDADE</span>
                    </div>
                    <p style="margin:0; font-size:13px; color:#155724; text-align:center;">
                        Todos os extintores est√£o dentro do prazo de validade
                    </p>
                </div>` : ''}
            </div>
        </div>

        <!-- PR√ìXIMAS A√á√ïES -->
        <div style="margin:15px 15mm 0 15mm; background:#fff; border:1px solid #e1e8ed; border-radius:12px; 
                    padding:25px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
            <h3 style="margin:0 0 18px 0; color:#2c3e50; font-size:18px; font-weight:700; text-align:center;">
                <i class="fas fa-tasks" style="margin-right:10px; color:#3498db;"></i>
                Pr√≥ximas A√ß√µes Recomendadas
            </h3>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; align-items:center; gap:12px; padding:12px; 
                            background:#f8f9fa; border-radius:8px;">
                    <i class="fas fa-calendar-check" style="color:#3498db; font-size:14px; width:20px; text-align:center;"></i>
                    <span style="font-size:14px; color:#2c3e50; text-align:left;">Realizar inspe√ß√£o visual mensal em todos os extintores</span>
                </div>
                <div style="display:flex; align-items:center; gap:12px; padding:12px; 
                            background:#f8f9fa; border-radius:8px;">
                    <i class="fas fa-clipboard-check" style="color:#27ae60; font-size:14px; width:20px; text-align:center;"></i>
                    <span style="font-size:14px; color:#2c3e50; text-align:left;">Verificar lacres e sinaliza√ß√µes de seguran√ßa</span>
                </div>
                <div style="display:flex; align-items:center; gap:12px; padding:12px; 
                            background:#f8f9fa; border-radius:8px;">
                    <i class="fas fa-wrench" style="color:#f39c12; font-size:14px; width:20px; text-align:center;"></i>
                    <span style="font-size:14px; color:#2c3e50; text-align:left;">Agendar manuten√ß√£o preventiva conforme cronograma</span>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div style="text-align:center; padding:15px 15mm; font-size:12px; color:#7f8c8d;
                    border-top:1px solid #e0e6ed; margin-top:auto; background:#fff;">
            Embalagens Tatu√≠ ‚Ä¢ P√°gina 1 ‚Ä¢ Relat√≥rio Corporativo
        </div>
    </div>`;

                // === P√ÅGINAS DE LISTAGEM ===
                const createPageHTML = (title, color, items, icon, pageNum, totalPages) => `
            <div style="width:210mm; height:297mm; background:#f8f9fa; display:flex; flex-direction:column;">
                <div style="background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%); color:white; padding:20px 15mm; text-align:center;">
                    <h1 style="margin:0; font-size:23px; font-weight:700;">
                        <i class="${icon}" style="margin-right:8px;"></i>${title}
                    </h1>
                    <p style="font-size:14px; margin-top:6px; opacity:0.9;">${items.length} extintores</p>
                </div>
                <div style="flex:1; padding:15mm; display:grid; grid-template-columns: repeat(2,1fr); gap:15px; align-content:start;">
                    ${items.map(createCardHTML).join('')}
                </div>
                <div style="text-align:center; padding:10px 0; font-size:12px; color:#7f8c8d; background:#fff; border-top:1px solid #e0e6ed;">
                    Embalagens Tatu√≠ ‚Ä¢ P√°gina ${pageNum} de ${totalPages}
                </div>
            </div>`;

                // === GERAR TODAS AS P√ÅGINAS ===
                let pages = [createFirstPageHTML()];
                let pageCounter = 2;

                const categories = [
                    { title: 'Em Conformidade', color: '#1e8449', items: statusGroups.ok, icon: 'fas fa-shield-alt' },
                    { title: 'Pr√≥ximos do Vencimento', color: '#d68910', items: statusGroups.proximo, icon: 'fas fa-clock' },
                    { title: 'Vencidos', color: '#c0392b', items: statusGroups.vencido, icon: 'fas fa-exclamation-triangle' }
                ];

                categories.forEach(cat => {
                    if (cat.items.length > 0) {
                        const chunks = chunkArray(cat.items, 8); // 8 por p√°gina
                        chunks.forEach(chunk => {
                            pages.push(createPageHTML(cat.title, cat.color, chunk, cat.icon, pageCounter++, 0));
                        });
                    }
                });

                const totalPages = pages.length;
                pages = pages.map((p, i) =>
                    p.replace(/P√°gina \d+ de \d+/, `P√°gina ${i + 1} de ${pages.length}`)
                );

                // === CONVERTER EM PDF ===
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                for (let i = 0; i < pages.length; i++) {
                    const el = document.createElement('div');
                    el.id = 'tempReport';
                    el.innerHTML = `<div style="font-family:'Segoe UI',sans-serif;">${pages[i]}</div>`;
                    document.body.appendChild(el);

                    await new Promise(r => setTimeout(r, 400));

                    const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: '#fff', width: 794, height: 1123 });
                    document.body.removeChild(el);

                    const imgData = canvas.toDataURL('image/png');
                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                }

                pdf.save(`Relatorio_Extintores_${new Date().toISOString().split('T')[0]}.pdf`);

            } catch (e) {
                console.error('Erro ao gerar relat√≥rio:', e);
                alert('Erro ao gerar relat√≥rio PDF.');
            }
        }

    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'98f2d9aa4712f1bb',t:'MTc2MDU2ODM2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>


</html>

